"use strict";var k=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var v=(r,t)=>{for(var e in t)k(r,e,{get:t[e],enumerable:!0})},E=(r,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of P(t))!q.call(r,n)&&n!==e&&k(r,n,{get:()=>t[n],enumerable:!(o=B(t,n))||o.enumerable});return r};var D=r=>E(k({},"__esModule",{value:!0}),r);var G={};v(G,{default:()=>A});module.exports=D(G);var u=require("obsidian"),F={booksRoot:"Books",templatePath:"Templates/BookTemplate.md",defaultAcquired:"Owned",defaultSource:"Audible",defaultStatus:"",defaultRating:"\u2B50\u2B50\u2B50",baseTags:["Book","Audible"],adultFantasyTags:["Adult","Fantasy","Erotic"]};function h(r){let t=(r??"").trim();if(!t)return"";try{let e=new URL(t);return e.search="",e.hash="",e.toString()}catch{return t.split("?")[0].split("#")[0]}}function m(r){return(r??"").replace(/\u00A0|\u202F|\u2009/g," ").replace(/\s+/g," ").trim()}function M(r){let t=m(r);return t=t.split(":").join(" - "),t=t.split("&").join(" and "),t=t.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),t=m(t),t=t.replace(/[. ]+$/g,"").trim(),t.length>180&&(t=t.slice(0,180).trim()),t}function x(r){let t=new Set,e=[];for(let o of r){let n=(o??"").trim();n&&(t.has(n)||(t.add(n),e.push(n)))}return e}function w(r){let t=m(r).replace(/&amp;/g,"&");if(!t)return[];let o=t.replace(/\s*(,|\||\/|•|·)\s*/g,",").replace(/\s*&\s*/g," & ").split(",").map(s=>s.trim()).filter(Boolean),n=[];for(let s of o){let a=s.includes(" & ")?s.split(" & ").map(i=>i.trim()).filter(Boolean):[s];for(let i of a){let p=i.replace(/[^\w\s-]/g,"").trim();if(!p)continue;let g=p.split(/\s+/).map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join("");g&&n.push(g)}}return x(n)}function C(r){let t=(r??"").trim();if(!t)return"";let e=t.startsWith("/")?`https://www.audible.com${t}`:t;return h(e)}function U(r){return new DOMParser().parseFromString(r,"text/html")}function j(r){let t=[],e=Array.from(r.querySelectorAll('script[type="application/ld+json"]'));for(let o of e){let n=(o.textContent??"").trim();if(n)try{let s=JSON.parse(n);if(Array.isArray(s))for(let a of s)a&&typeof a=="object"&&t.push(a);else s&&typeof s=="object"&&t.push(s)}catch{}}return t}function R(r){for(let t of r){let e=t?.["@type"];if((Array.isArray(e)?e.map(n=>String(n).toLowerCase()):[String(e??"").toLowerCase()]).some(n=>["book","audiobook","product","creativework"].includes(n)))return t}return r.length?r[0]:null}function $(r,t,e){let o=typeof e?.name=="string"?m(e.name):"",n=typeof e?.url=="string"?h(e.url):"";if(o)return{title:o,url:n||h(t)};let s=r.querySelector('meta[property="og:title"]')?.content??r.querySelector('meta[name="og:title"]')?.content??"";return s?{title:m(s),url:h(t)}:{title:"Unknown Title",url:h(t)}}function N(r,t){let e=t?.image;if(typeof e=="string"&&e.startsWith("http"))return h(e);if(Array.isArray(e)&&typeof e[0]=="string")return h(e[0]);let o=r.querySelector('meta[property="og:image"]')?.content??r.querySelector('meta[name="og:image"]')?.content??"";return o?h(o):""}function H(r,t){let e=typeof t?.description=="string"?m(t.description):"";if(e)return e;let o=r.querySelector('meta[property="og:description"]')?.content??r.querySelector('meta[name="og:description"]')?.content??"";return o?m(o):""}function S(r){let t=new Set,e=[];for(let o of r){let n=m(o.name);if(!n)continue;let s=n.toLowerCase();t.has(s)||(t.add(s),e.push({name:n,url:h(o.url??"")}))}return e}function O(r,t){let e=[],o=(l,d)=>{let b=m(l);b&&e.push({name:b,url:h(d??"")})},n=t?.author;if(Array.isArray(n))for(let l of n)typeof l=="string"?o(l):l&&typeof l=="object"&&o(l.name??"",l.url??"");else n&&typeof n=="object"?o(n.name??"",n.url??""):typeof n=="string"&&o(n);let s=S(e);if(!(s.length===0||s.some(l=>!l.url)))return s;let i=[],p=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]'];for(let l of p)i.push(...Array.from(r.querySelectorAll(l)));let g=Array.from(r.querySelectorAll("div,span,section"));for(let l of g){let d=l.textContent??"";/(\bBy\b|\bWritten by\b|\bAuthor\b)/i.test(d)&&l.querySelector('a[href*="/author/"]')&&i.push(l)}let c=new Map;for(let l of i){let d=Array.from(l.querySelectorAll('a[href*="/author/"]'));for(let b of d){let y=m(b.textContent??"");y&&c.set(y.toLowerCase(),C(b.getAttribute("href")??""))}}if(s.length)return s=s.map(l=>{if(l.url)return l;let d=c.get(l.name.toLowerCase())??"";return{name:l.name,url:h(d)}}),S(s);let f=[];for(let[l,d]of c.entries()){let b=l.replace(/\b\w/g,y=>y.toUpperCase());f.push({name:b,url:h(d)})}return S(f)}function _(r){let t=a=>{let p=m(a).match(/\bBook\s+(\d+)\b/i);return p?p[1]:""},e=r.querySelector('div[data-testid="line"][data-event-id="series"]')||r.querySelector('div[data-testid="line"][key="series"]');if(!e){let a=Array.from(r.querySelectorAll('div[data-testid="line"]'));for(let i of a){let p=i.querySelector(".label");if(m(p?.textContent??"").toLowerCase()==="series"){e=i;break}}}let o="",n="",s="";if(e){let a=e.querySelector('a.link[href*="/series/"]');a&&(o=m(a.textContent??""),n=C(a.getAttribute("href")??"")),s=t(e.textContent??"")}if(!n){let a=r.querySelector('a[href*="/series/"]');if(a){o=m(a.textContent??""),n=C(a.getAttribute("href")??"");let i=a.parentElement;for(let p=0;p<4&&i&&!s;p++)s=t(i.textContent??""),i=i.parentElement}}if(!(!o||!n))return{name:o,url:h(n),book:s??""}}function I(r,t){let e=[],o=Array.from(r.querySelectorAll("adbl-chip-group.product-topictag-impression adbl-chip"));for(let i of o){let p=m(i.textContent??"");p&&e.push(...w(p))}let n=r.querySelector('div[data-testid="line"][key="categories"]');if(n){let i=Array.from(n.querySelectorAll("a.link[href]"));for(let p of i){let g=m(p.textContent??"");g&&e.push(...w(g))}}let s=t?.genre;if(typeof s=="string")e.push(...w(s));else if(Array.isArray(s))for(let i of s)typeof i=="string"&&e.push(...w(i));let a=new Set(["audible","audiobooks","audiobook"]);return e=e.filter(i=>i&&!a.has(i.toLowerCase())),x(e)}async function W(r,t){let e=(t??"").trim();if(!e)throw new Error("Template path is empty.");let o=e.replace(/\\/g,"/").replace(/^\/+/,""),n=r.vault.getAbstractFileByPath(o);if(!n||!(n instanceof u.TFile))throw new Error(`Template not found: ${o}`);return await r.vault.read(n)}function J(r,t){let e=t.authors.map(f=>f.name).filter(Boolean).join(", "),o=t.authors.length?t.authors.map(f=>f.url?`[${f.name}](${h(f.url)})`:f.name).join(`,  
`):"_Unknown_",n=t.series?.name??"",s=t.series?t.series.url?`[${t.series.name}](${h(t.series.url)})`:t.series.name:"",a=t.series?.book??"",i=t.tags.map(f=>`#${f}`).join(" "),p="["+t.tags.map(f=>JSON.stringify(f)).join(",")+"]",g=r,c=(f,l)=>{g=g.split(f).join(l)};return c("{{type}}",t.type??""),c("{{status}}",t.status??""),c("{{category}}",t.category??""),c("{{acquired}}",t.acquired??""),c("{{source}}",t.source??""),c("{{title}}",t.title??""),c("{{url}}",h(t.url??"")),c("{{cover_url}}",h(t.coverUrl??"")),c("{{authors_md}}",o),c("{{authors_plain}}",e),c("{{series_md}}",s),c("{{series_plain}}",n),c("{{book_md}}",a),c("{{description}}",(t.description??"").trim()),c("{{rating}}",t.rating??""),c("{{tags}}",i),c("{{tags_yaml}}",p),g=g.replace(/\n{4,}/g,`


`),g.trim()+`
`}async function V(r,t,e){let n=(await(0,u.requestUrl)({url:r,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,s=U(n),a=j(s),i=R(a),{title:p,url:g}=$(s,r,i),c=M(p),f=N(s,i),l=H(s,i),d=O(s,i),b=_(s),y=[];return y.push(...e.baseTags),y.push(...I(s,i)),t.trim().toLowerCase()==="adult fantasy"&&y.push(...e.adultFantasyTags),y=x(y),{title:c,url:h(g),coverUrl:f,authors:d,series:b,description:l,category:t,status:e.defaultStatus,acquired:e.defaultAcquired,source:e.defaultSource,rating:e.defaultRating,tags:y,type:"book"}}async function z(r,t){let e=r.vault.getAbstractFileByPath(t);return(e&&"children"in e?e.children:[]).filter(s=>s&&s.path&&s.path.startsWith(t+"/")&&s.children).map(s=>s.path.split("/").pop()).sort((s,a)=>s.localeCompare(a))}var T=class extends u.Modal{constructor(e,o){super(e);this.url="";this.category="";this.newCategory="";this.plugin=o}async onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Create Book from Audible"});let o=await z(this.app,this.plugin.settings.booksRoot);new u.Setting(e).setName("Audible URL").setDesc("Paste the Audible book page URL (https://www.audible.com/pd/...)").addText(n=>{n.setPlaceholder("https://www.audible.com/pd/...").onChange(s=>this.url=s.trim()),n.inputEl.style.width="100%"}),new u.Setting(e).setName("Category / Folder").setDesc("Where under Books/ should this note be created?").addDropdown(n=>{n.addOption("","\u2014 Select \u2014"),o.forEach(s=>n.addOption(s,s)),n.onChange(s=>this.category=s)}),new u.Setting(e).setName("New category (optional)").setDesc("If you type a new one here, it will be created and used.").addText(n=>{n.setPlaceholder("e.g. Helpful Informative").onChange(s=>this.newCategory=s.trim()),n.inputEl.style.width="100%"}),new u.Setting(e).addButton(n=>{n.setButtonText("Create").setCta().onClick(async()=>{try{let s=this.newCategory||this.category;if(!this.url){new u.Notice("Please enter an Audible URL.");return}if(!s){new u.Notice("Please select a category or enter a new one.");return}await this.plugin.createBookFromAudible(this.url,s),this.close()}catch(s){console.error(s),new u.Notice(`Failed: ${s?.message??String(s)}`)}})}),new u.Setting(e).addButton(n=>{n.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},L=class extends u.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Audible Library Creator Settings"}),new u.Setting(t).setName("Books root folder").setDesc('Usually "Books"').addText(e=>{e.setValue(this.plugin.settings.booksRoot).onChange(async o=>{this.plugin.settings.booksRoot=o.trim()||"Books",await this.plugin.saveSettings()})}),new u.Setting(t).setName("Template path").setDesc('Vault-relative path (e.g. "Templates/BookTemplate.md")').addText(e=>{e.setValue(this.plugin.settings.templatePath).onChange(async o=>{this.plugin.settings.templatePath=o.trim()||"Templates/BookTemplate.md",await this.plugin.saveSettings()})})}},A=class extends u.Plugin{async onload(){await this.loadSettings(),this.addCommand({id:"create-book-from-audible",name:"Create Book from Audible",callback:()=>new T(this.app,this).open()}),this.addSettingTab(new L(this.app,this))}async loadSettings(){this.settings=Object.assign({},F,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createBookFromAudible(t,e){let n=`${this.settings.booksRoot}/${e}`.replace(/\\/g,"/");this.app.vault.getAbstractFileByPath(n)||await this.app.vault.createFolder(n),new u.Notice("Fetching Audible page\u2026");let a=await V(t,e,this.settings),i=await W(this.app,this.settings.templatePath),p=J(i,a),g=`${n}/${a.title}.md`;if(this.app.vault.getAbstractFileByPath(g)){new u.Notice(`Already exists: ${g}`);return}await this.app.vault.create(g,p),new u.Notice(`Created: ${a.title}`);let f=this.app.vault.getAbstractFileByPath(g);f&&f instanceof u.TFile&&await this.app.workspace.getLeaf(!0).openFile(f)}};
