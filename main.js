"use strict";var v=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var q=(a,e)=>{for(var s in e)v(a,s,{get:e[s],enumerable:!0})},M=(a,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of B(e))!R.call(a,r)&&r!==s&&v(a,r,{get:()=>e[r],enumerable:!(t=N(e,r))||t.enumerable});return a};var O=a=>M(v({},"__esModule",{value:!0}),a);var Z={};q(Z,{default:()=>C});module.exports=O(Z);var g=require("obsidian");var f=require("obsidian"),D={booksRoot:"Books",authorsFolder:"Books/Authors",seriesFolder:"Books/Series",archiveFolder:"Books/Archive",bookTemplatePath:"Templates/BookTemplate.md",authorTemplatePath:"Templates/AuthorTemplate.md",seriesTemplatePath:"Templates/SeriesTemplate.md",archiveTemplatePath:"Templates/ArchiveTemplate.md",defaultCategory:"Fiction",defaultStatus:"",defaultAcquired:"Owned",defaultSource:"Audible",defaultRatingNumber:3,ratingStyle:"emoji",allowHalfStars:!0,separateCategoriesIntoSubfolders:!0,createArchivesPerSubfolder:!1,createSeriesPages:!1,openCreatedFile:!0,overwriteIfExists:!1,tagRulesJson:JSON.stringify({baseTags:["Book","Audible"],categoryTags:{"Adult Fantasy":["Adult","Fantasy","Erotic"]}},null,2)};function S(a){return(a||"").replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"").trim()}function I(a){try{let e=JSON.parse(a),s=Array.isArray(e?.baseTags)?e.baseTags.map(String):[],t=e?.categoryTags&&typeof e.categoryTags=="object"?e.categoryTags:{},r={};for(let n of Object.keys(t)){let i=t[n];Array.isArray(i)&&(r[n]=i.map(String))}return{rules:{baseTags:s,categoryTags:r},error:""}}catch(e){return{rules:{baseTags:[],categoryTags:{}},error:e?.message||"Invalid JSON"}}}var T=class extends f.PluginSettingTab{constructor(e,s){super(e,s),this.plugin=s}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Audible Library Creator"});let s=[{key:"paths",label:"Paths & Templates"},{key:"defaults",label:"Defaults"},{key:"features",label:"Features"},{key:"tags",label:"Tags & Category Rules"},{key:"advanced",label:"Advanced / Importers"}],t="paths",r=()=>{e.findAll("div.alc-section").forEach(i=>i.remove());let n=e.createDiv({cls:"alc-section"});t==="paths"&&this.renderPaths(n),t==="defaults"&&this.renderDefaults(n),t==="features"&&this.renderFeatures(n),t==="tags"&&this.renderTags(n),t==="advanced"&&this.renderAdvanced(n)};new f.Setting(e).setName("Settings section").setDesc("Choose which settings group to view.").addDropdown(n=>{for(let i of s)n.addOption(i.key,i.label);n.setValue(t),n.onChange(i=>{t=i,r()})}),r()}renderPaths(e){e.createEl("h3",{text:"Paths & Templates"});let s=this.plugin.settings,t=(r,n,i)=>{new f.Setting(e).setName(r).setDesc(n).addText(o=>{o.setPlaceholder("Vault-relative path"),o.setValue(String(s[i]||"")),o.onChange(async u=>{this.plugin.settings[i]=S(u),await this.plugin.saveSettings()})})};t("Books root folder","Where book notes are created (ex: Books).","booksRoot"),t("Authors folder","Where author notes are created (ex: Books/Authors).","authorsFolder"),t("Series folder","Where series notes are created (ex: Books/Series).","seriesFolder"),t("Archive folder","Where archive notes are created (ex: Books/Archive).","archiveFolder"),t("Book template path","Template for book notes.","bookTemplatePath"),t("Author template path","Template for author notes (optional for now).","authorTemplatePath"),t("Series template path","Template for series notes (optional for now).","seriesTemplatePath"),t("Archive template path","Template for archive notes (optional for now).","archiveTemplatePath")}renderDefaults(e){e.createEl("h3",{text:"Defaults"});let s=this.plugin.settings;new f.Setting(e).setName("Default category").setDesc("Used when category is not provided in the modal.").addText(t=>{t.setValue(s.defaultCategory||""),t.onChange(async r=>{this.plugin.settings.defaultCategory=r.trim(),await this.plugin.saveSettings()})}),new f.Setting(e).setName("Default status").setDesc("Blank by default is recommended for bulk importing.").addText(t=>{t.setValue(s.defaultStatus||""),t.onChange(async r=>{this.plugin.settings.defaultStatus=r.trim(),await this.plugin.saveSettings()})}),new f.Setting(e).setName("Default acquired").setDesc("Example: Owned, Wish Listed.").addText(t=>{t.setValue(s.defaultAcquired||""),t.onChange(async r=>{this.plugin.settings.defaultAcquired=r.trim(),await this.plugin.saveSettings()})}),new f.Setting(e).setName("Default source").setDesc("Example: Audible.").addText(t=>{t.setValue(s.defaultSource||""),t.onChange(async r=>{this.plugin.settings.defaultSource=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h4",{text:"Rating"}),new f.Setting(e).setName("Default rating number").setDesc("Example: 3 or 3.5").addText(t=>{t.setValue(String(s.defaultRatingNumber)),t.onChange(async r=>{let n=Number(r);Number.isFinite(n)&&(this.plugin.settings.defaultRatingNumber=n,await this.plugin.saveSettings())})}),new f.Setting(e).setName("Rating style").setDesc("Emoji stars or classic symbols.").addDropdown(t=>{t.addOption("emoji","Emoji (\u2B50)"),t.addOption("classic","Classic (\u2605)"),t.setValue(s.ratingStyle),t.onChange(async r=>{this.plugin.settings.ratingStyle=r,await this.plugin.saveSettings()})}),new f.Setting(e).setName("Allow half stars").setDesc("If enabled, 3.5 can render as 3 and a half.").addToggle(t=>{t.setValue(s.allowHalfStars),t.onChange(async r=>{this.plugin.settings.allowHalfStars=r,await this.plugin.saveSettings()})})}renderFeatures(e){e.createEl("h3",{text:"Features"});let s=this.plugin.settings;new f.Setting(e).setName("Separate categories into subfolders").setDesc("Allows categories like Helpful Informative/Finance.").addToggle(t=>{t.setValue(s.separateCategoriesIntoSubfolders),t.onChange(async r=>{this.plugin.settings.separateCategoriesIntoSubfolders=r,await this.plugin.saveSettings()})}),new f.Setting(e).setName("Create archives per subfolder").setDesc("Optional, not implemented yet (placeholder).").addToggle(t=>{t.setValue(s.createArchivesPerSubfolder),t.onChange(async r=>{this.plugin.settings.createArchivesPerSubfolder=r,await this.plugin.saveSettings()})}),new f.Setting(e).setName("Create series pages").setDesc("Optional, not implemented yet (placeholder).").addToggle(t=>{t.setValue(s.createSeriesPages),t.onChange(async r=>{this.plugin.settings.createSeriesPages=r,await this.plugin.saveSettings()})}),e.createEl("h4",{text:"Creation behavior"}),new f.Setting(e).setName("Open created file automatically").addToggle(t=>{t.setValue(s.openCreatedFile),t.onChange(async r=>{this.plugin.settings.openCreatedFile=r,await this.plugin.saveSettings()})}),new f.Setting(e).setName("Overwrite if exists").setDesc("If a file already exists, replace it.").addToggle(t=>{t.setValue(s.overwriteIfExists),t.onChange(async r=>{this.plugin.settings.overwriteIfExists=r,await this.plugin.saveSettings()})})}renderTags(e){e.createEl("h3",{text:"Tags & Category Rules"});let s=this.plugin.settings,t=I(s.tagRulesJson);t.error&&e.createEl("p",{text:`JSON error: ${t.error}`}),new f.Setting(e).setName("Tag rules (JSON)").setDesc("Controls base tags and per-category tags.").addTextArea(r=>{r.setValue(s.tagRulesJson),r.inputEl.rows=14,r.onChange(async n=>{this.plugin.settings.tagRulesJson=n,await this.plugin.saveSettings()})})}renderAdvanced(e){e.createEl("h3",{text:"Advanced / Importers"}),e.createEl("p",{text:"Coming soon: batch import from library and wishlist pages."})}};function h(a){let e=(a??"").trim();if(!e)return"";try{let s=new URL(e);return s.search="",s.hash="",s.toString()}catch{return e.split("?")[0].split("#")[0]}}function m(a){return(a??"").replace(/\u00A0|\u202F|\u2009/g," ").replace(/\s+/g," ").trim()}function j(a){let e=m(a);return e=e.split(":").join(" - "),e=e.split("&").join(" and "),e=e.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),e=m(e),e=e.replace(/[. ]+$/g,"").trim(),e.length>180&&(e=e.slice(0,180).trim()),e}function L(a){let e=new Set,s=[];for(let t of a){let r=(t??"").trim();r&&(e.has(r)||(e.add(r),s.push(r)))}return s}function A(a){let e=m(a).replace(/&amp;/g,"&");if(!e)return[];let t=e.replace(/\s*(,|\||\/|•|·)\s*/g,",").replace(/\s*&\s*/g," & ").split(",").map(n=>n.trim()).filter(Boolean),r=[];for(let n of t){let i=n.includes(" & ")?n.split(" & ").map(o=>o.trim()).filter(Boolean):[n];for(let o of i){let u=o.replace(/[^\w\s-]/g,"").trim();if(!u)continue;let d=u.split(/\s+/).map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join("");d&&r.push(d)}}return L(r)}function P(a){let e=(a??"").trim();if(!e)return"";let s=e.startsWith("/")?`https://www.audible.com${e}`:e;return h(s)}function H(a){return new DOMParser().parseFromString(a,"text/html")}function U(a){let e=[],s=Array.from(a.querySelectorAll('script[type="application/ld+json"]'));for(let t of s){let r=(t.textContent??"").trim();if(r)try{let n=JSON.parse(r);if(Array.isArray(n))for(let i of n)i&&typeof i=="object"&&e.push(i);else n&&typeof n=="object"&&e.push(n)}catch{}}return e}function $(a){for(let e of a){let s=e?.["@type"];if((Array.isArray(s)?s.map(r=>String(r).toLowerCase()):[String(s??"").toLowerCase()]).some(r=>["book","audiobook","product","creativework"].includes(r)))return e}return a.length?a[0]:null}function J(a,e,s){let t=typeof s?.name=="string"?m(s.name):"",r=typeof s?.url=="string"?h(s.url):"";if(t)return{title:t,url:r||h(e)};let n=a.querySelector('meta[property="og:title"]')?.content??a.querySelector('meta[name="og:title"]')?.content??"";return n?{title:m(n),url:h(e)}:{title:"Unknown Title",url:h(e)}}function V(a,e){let s=e?.image;if(typeof s=="string"&&s.startsWith("http"))return h(s);if(Array.isArray(s)&&typeof s[0]=="string")return h(s[0]);let t=a.querySelector('meta[property="og:image"]')?.content??a.querySelector('meta[name="og:image"]')?.content??"";return t?h(t):""}function W(a,e){let s=typeof e?.description=="string"?m(e.description):"";if(s)return s;let t=a.querySelector('meta[property="og:description"]')?.content??a.querySelector('meta[name="og:description"]')?.content??"";return t?m(t):""}function x(a){let e=new Set,s=[];for(let t of a){let r=m(t.name);if(!r)continue;let n=r.toLowerCase();e.has(n)||(e.add(n),s.push({name:r,url:h(t.url??"")}))}return s}function _(a,e){let s=[],t=(l,y)=>{let w=m(l);w&&s.push({name:w,url:h(y??"")})},r=e?.author;if(Array.isArray(r))for(let l of r)typeof l=="string"?t(l):l&&typeof l=="object"&&t(l.name??"",l.url??"");else r&&typeof r=="object"?t(r.name??"",r.url??""):typeof r=="string"&&t(r);let n=x(s);if(!(n.length===0||n.some(l=>!l.url)))return n;let o=[],u=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]'];for(let l of u)o.push(...Array.from(a.querySelectorAll(l)));let d=Array.from(a.querySelectorAll("div,span,section"));for(let l of d){let y=l.textContent??"";/(\bBy\b|\bWritten by\b|\bAuthor\b)/i.test(y)&&l.querySelector('a[href*="/author/"]')&&o.push(l)}let c=new Map;for(let l of o){let y=Array.from(l.querySelectorAll('a[href*="/author/"]'));for(let w of y){let b=m(w.textContent??"");b&&c.set(b.toLowerCase(),P(w.getAttribute("href")??""))}}if(n.length)return n=n.map(l=>{if(l.url)return l;let y=c.get(l.name.toLowerCase())??"";return{name:l.name,url:h(y)}}),x(n);let p=[];for(let[l,y]of c.entries()){let w=l.replace(/\b\w/g,b=>b.toUpperCase());p.push({name:w,url:h(y)})}return x(p)}function z(a){let e=i=>{let u=m(i).match(/\bBook\s+(\d+)\b/i);return u?u[1]:""},s=a.querySelector('div[data-testid="line"][data-event-id="series"]')||a.querySelector('div[data-testid="line"][key="series"]');if(!s){let i=Array.from(a.querySelectorAll('div[data-testid="line"]'));for(let o of i){let u=o.querySelector(".label");if(m(u?.textContent??"").toLowerCase()==="series"){s=o;break}}}let t="",r="",n="";if(s){let i=s.querySelector('a.link[href*="/series/"]');i&&(t=m(i.textContent??""),r=P(i.getAttribute("href")??"")),n=e(s.textContent??"")}if(!r){let i=a.querySelector('a[href*="/series/"]');if(i){t=m(i.textContent??""),r=P(i.getAttribute("href")??"");let o=i.parentElement;for(let u=0;u<4&&o&&!n;u++)n=e(o.textContent??""),o=o.parentElement}}if(!(!t||!r))return{name:t,url:h(r),book:n??""}}function G(a,e){let s=[],t=Array.from(a.querySelectorAll("adbl-chip-group.product-topictag-impression adbl-chip"));for(let o of t){let u=m(o.textContent??"");u&&s.push(...A(u))}let r=a.querySelector('div[data-testid="line"][key="categories"]');if(r){let o=Array.from(r.querySelectorAll("a.link[href]"));for(let u of o){let d=m(u.textContent??"");d&&s.push(...A(d))}}let n=e?.genre;if(typeof n=="string")s.push(...A(n));else if(Array.isArray(n))for(let o of n)typeof o=="string"&&s.push(...A(o));let i=new Set(["audible","audiobooks","audiobook"]);return s=s.filter(o=>o&&!i.has(o.toLowerCase())),L(s)}async function K(a,e){let s=(e??"").trim();if(!s)throw new Error("Template path is empty.");let t=s.replace(/\\/g,"/").replace(/^\/+/,""),r=a.vault.getAbstractFileByPath(t);if(!r||!(r instanceof g.TFile))throw new Error(`Template not found: ${t}`);return await a.vault.read(r)}function Y(a,e){let s=e.authors.map(p=>p.name).filter(Boolean).join(", "),t=e.authors.length?e.authors.map(p=>p.url?`[${p.name}](${h(p.url)})`:p.name).join(`,  
`):"_Unknown_",r=e.series?.name??"",n=e.series?e.series.url?`[${e.series.name}](${h(e.series.url)})`:e.series.name:"",i=e.series?.book??"",o=e.tags.map(p=>`#${p}`).join(" "),u="["+e.tags.map(p=>JSON.stringify(p)).join(",")+"]",d=a,c=(p,l)=>{d=d.split(p).join(l)};return c("{{type}}",e.type??""),c("{{status}}",e.status??""),c("{{category}}",e.category??""),c("{{acquired}}",e.acquired??""),c("{{source}}",e.source??""),c("{{title}}",e.title??""),c("{{url}}",h(e.url??"")),c("{{cover_url}}",h(e.coverUrl??"")),c("{{authors_md}}",t),c("{{authors_plain}}",s),c("{{series_md}}",n),c("{{series_plain}}",r),c("{{book_md}}",i),c("{{description}}",(e.description??"").trim()),c("{{rating}}",e.rating??""),c("{{tags}}",o),c("{{tags_yaml}}",u),d=d.replace(/\n{4,}/g,`


`),d.trim()+`
`}async function Q(a,e,s){let r=(await(0,g.requestUrl)({url:a,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,n=H(r),i=U(n),o=$(i),{title:u,url:d}=J(n,a,o),c=j(u),p=V(n,o),l=W(n,o),y=_(n,o),w=z(n),b=[],F=JSON.parse(s.tagRulesJson);b.push(...F.baseTags||[]),b.push(...G(n,o));let k=F.categoryTags?.[e];return k&&Array.isArray(k)&&b.push(...k),b=L(b),{title:c,url:h(d),coverUrl:p,authors:y,series:w,description:l,category:e,status:s.defaultStatus,acquired:s.defaultAcquired,source:s.defaultSource,rating:String(s.defaultRatingNumber),tags:b,type:"book"}}async function X(a,e){let s=a.vault.getAbstractFileByPath(e);return(s&&"children"in s?s.children:[]).filter(n=>n&&n.path&&n.path.startsWith(e+"/")&&n.children).map(n=>n.path.split("/").pop()).sort((n,i)=>n.localeCompare(i))}var E=class extends g.Modal{constructor(s,t){super(s);this.url="";this.category="";this.newCategory="";this.plugin=t}async onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Book from Audible"});let t=await X(this.app,this.plugin.settings.booksRoot);new g.Setting(s).setName("Audible URL").setDesc("Paste the Audible book page URL (https://www.audible.com/pd/...)").addText(r=>{r.setPlaceholder("https://www.audible.com/pd/...").onChange(n=>this.url=n.trim()),r.inputEl.style.width="100%"}),new g.Setting(s).setName("Category / Folder").setDesc("Where under Books/ should this note be created?").addDropdown(r=>{r.addOption("","\u2014 Select \u2014"),t.forEach(n=>r.addOption(n,n)),r.onChange(n=>this.category=n)}),new g.Setting(s).setName("New category (optional)").setDesc("If you type a new one here, it will be created and used.").addText(r=>{r.setPlaceholder("e.g. Helpful Informative").onChange(n=>this.newCategory=n.trim()),r.inputEl.style.width="100%"}),new g.Setting(s).addButton(r=>{r.setButtonText("Create").setCta().onClick(async()=>{try{let n=this.newCategory||this.category;if(!this.url){new g.Notice("Please enter an Audible URL.");return}if(!n){new g.Notice("Please select a category or enter a new one.");return}await this.plugin.createBookFromAudible(this.url,n),this.close()}catch(n){console.error(n),new g.Notice(`Failed: ${n?.message??String(n)}`)}})}),new g.Setting(s).addButton(r=>{r.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},C=class extends g.Plugin{async onload(){await this.loadSettings(),this.addCommand({id:"create-book-from-audible",name:"Create Book from Audible",callback:()=>new E(this.app,this).open()}),this.addSettingTab(new T(this.app,this))}async loadSettings(){this.settings=Object.assign({},D,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createBookFromAudible(e,s){let t=this.settings,r=S(t.booksRoot),n=s||t.defaultCategory,i=r;n&&t.separateCategoriesIntoSubfolders&&(i=S(`${r}/${n}`)),this.app.vault.getAbstractFileByPath(i)||await this.app.vault.createFolder(i),new g.Notice("Fetching Audible page\u2026");let u=await Q(e,n,t),d=await K(this.app,t.bookTemplatePath),c=Y(d,u),p=S(`${i}/${u.title}.md`),l=this.app.vault.getAbstractFileByPath(p);if(l&&l instanceof g.TFile){if(!t.overwriteIfExists){new g.Notice(`File exists: ${p}`),t.openCreatedFile&&await this.app.workspace.getLeaf(!1).openFile(l);return}await this.app.vault.modify(l,c),new g.Notice(`Updated: ${u.title}`)}else await this.app.vault.create(p,c),new g.Notice(`Created: ${u.title}`);if(t.openCreatedFile){let y=this.app.vault.getAbstractFileByPath(p);y&&y instanceof g.TFile&&await this.app.workspace.getLeaf(!1).openFile(y)}}};
