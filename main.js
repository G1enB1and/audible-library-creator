"use strict";var C=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var q=(a,e)=>{for(var r in e)C(a,r,{get:e[r],enumerable:!0})},I=(a,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of B(e))!R.call(a,t)&&t!==r&&C(a,t,{get:()=>e[t],enumerable:!(s=F(e,t))||s.enumerable});return a};var M=a=>I(C({},"__esModule",{value:!0}),a);var X={};q(X,{default:()=>v});module.exports=M(X);var p=require("obsidian");var g=require("obsidian"),D={bookTemplatePath:"Templates/BookTemplate.md",authorTemplatePath:"Templates/AuthorTemplate.md",seriesTemplatePath:"Templates/SeriesTemplate.md",archiveTemplatePath:"Templates/ArchiveTemplate.md",libraries:[{id:"default",name:"Main Library",booksRoot:"Books",authorsFolder:"Books/Authors",seriesFolder:"Books/Series",archivePath:"Books/Archive/!Archive.md"}],activeLibraryId:"default",defaultCategory:"Fiction",defaultStatus:"",defaultAcquired:"Owned",defaultSource:"Audible",defaultRatingNumber:3,ratingStyle:"classic",allowHalfStars:!0,createSeriesPages:!1,openCreatedFile:!0,overwriteIfExists:!1,tagRulesJson:JSON.stringify({baseTags:["Book","Audible"],categoryTags:{"Adult Fantasy":["Adult","Fantasy","Erotic"]}},null,2)};function S(a){return(a||"").replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"").trim()}function O(a){try{let e=JSON.parse(a),r=Array.isArray(e?.baseTags)?e.baseTags.map(String):[],s=e?.categoryTags&&typeof e.categoryTags=="object"?e.categoryTags:{},t={};for(let n of Object.keys(s)){let o=s[n];Array.isArray(o)&&(t[n]=o.map(String))}return{rules:{baseTags:r,categoryTags:t},error:""}}catch(e){return{rules:{baseTags:[],categoryTags:{}},error:e?.message||"Invalid JSON"}}}var T=class extends g.PluginSettingTab{constructor(e,r){super(e,r),this.plugin=r}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Audible Library Creator"});let r=[{key:"paths",label:"Paths & Templates"},{key:"defaults",label:"Defaults"},{key:"features",label:"Features"},{key:"tags",label:"Tags & Category Rules"},{key:"advanced",label:"Advanced / Importers"}],s="paths",t=()=>{e.findAll("div.alc-section").forEach(o=>o.remove());let n=e.createDiv({cls:"alc-section"});s==="paths"&&this.renderPaths(n),s==="defaults"&&this.renderDefaults(n),s==="features"&&this.renderFeatures(n),s==="tags"&&this.renderTags(n),s==="advanced"&&this.renderAdvanced(n)};new g.Setting(e).setName("Settings section").setDesc("Choose which settings group to view.").addDropdown(n=>{for(let o of r)n.addOption(o.key,o.label);n.setValue(s),n.onChange(o=>{s=o,t()})}),t()}renderPaths(e){e.createEl("h3",{text:"Templates"});let r=this.plugin.settings,s=(t,n,o)=>{new g.Setting(e).setName(t).setDesc(n).addText(i=>{i.setPlaceholder("Templates/MyTemplate.md"),i.setValue(String(r[o]||"")),i.onChange(async l=>{this.plugin.settings[o]=S(l),await this.plugin.saveSettings()})})};s("Book template path","Template for book notes.","bookTemplatePath"),s("Author template path","Template for author notes (optional).","authorTemplatePath"),s("Series template path","Template for series notes (optional).","seriesTemplatePath"),s("Archive template path","Template for archive notes (optional).","archiveTemplatePath"),e.createEl("h3",{text:"Libraries"}),e.createEl("p",{text:"Configure separate paths for different categories/genres. Each library has its own folders for books, authors, and series, and its own archive file."}),r.libraries.forEach((t,n)=>{let o=e.createDiv({cls:"alc-library-item"});o.style.border="1px solid var(--background-modifier-border)",o.style.padding="10px",o.style.marginBottom="10px",o.style.borderRadius="8px",new g.Setting(o).setName(`Library: ${t.name}`).addExtraButton(i=>{i.setIcon("trash").setTooltip("Delete this library").onClick(async()=>{if(r.libraries.length<=1){new Notice("You must have at least one library.");return}r.libraries.splice(n,1),r.activeLibraryId===t.id&&(r.activeLibraryId=r.libraries[0].id),await this.plugin.saveSettings(),this.display()})}),new g.Setting(o).setName("Library name").addText(i=>{i.setValue(t.name),i.onChange(async l=>{t.name=l.trim(),await this.plugin.saveSettings()})}),new g.Setting(o).setName("Books root").setDesc("Where book notes are created.").addText(i=>{i.setValue(t.booksRoot),i.onChange(async l=>{t.booksRoot=S(l),await this.plugin.saveSettings()})}),new g.Setting(o).setName("Authors folder").addText(i=>{i.setValue(t.authorsFolder),i.onChange(async l=>{t.authorsFolder=S(l),await this.plugin.saveSettings()})}),new g.Setting(o).setName("Series folder").addText(i=>{i.setValue(t.seriesFolder),i.onChange(async l=>{t.seriesFolder=S(l),await this.plugin.saveSettings()})}),new g.Setting(o).setName("Archive path").setDesc("Path to the archive .md file.").addText(i=>{i.setValue(t.archivePath),i.onChange(async l=>{t.archivePath=S(l),await this.plugin.saveSettings()})})}),new g.Setting(e).addButton(t=>{t.setButtonText("Add Library").setCta().onClick(async()=>{let n="lib-"+Date.now();r.libraries.push({id:n,name:"New Library",booksRoot:"Books/New",authorsFolder:"Books/New/Authors",seriesFolder:"Books/New/Series",archivePath:"Books/New/!Archive.md"}),await this.plugin.saveSettings(),this.display()})})}renderDefaults(e){e.createEl("h3",{text:"Defaults"});let r=this.plugin.settings;new g.Setting(e).setName("Default category").setDesc("Used when category is not provided in the modal.").addText(s=>{s.setValue(r.defaultCategory||""),s.onChange(async t=>{this.plugin.settings.defaultCategory=t.trim(),await this.plugin.saveSettings()})}),new g.Setting(e).setName("Default status").setDesc("Blank by default is recommended for bulk importing.").addText(s=>{s.setValue(r.defaultStatus||""),s.onChange(async t=>{this.plugin.settings.defaultStatus=t.trim(),await this.plugin.saveSettings()})}),new g.Setting(e).setName("Default acquired").setDesc("Example: Owned, Wish Listed.").addText(s=>{s.setValue(r.defaultAcquired||""),s.onChange(async t=>{this.plugin.settings.defaultAcquired=t.trim(),await this.plugin.saveSettings()})}),new g.Setting(e).setName("Default source").setDesc("Example: Audible.").addText(s=>{s.setValue(r.defaultSource||""),s.onChange(async t=>{this.plugin.settings.defaultSource=t.trim(),await this.plugin.saveSettings()})}),e.createEl("h4",{text:"Rating"}),new g.Setting(e).setName("Default rating number").setDesc("Example: 3 or 3.5").addText(s=>{s.setValue(String(r.defaultRatingNumber)),s.onChange(async t=>{let n=Number(t);Number.isFinite(n)&&(this.plugin.settings.defaultRatingNumber=n,await this.plugin.saveSettings())})}),new g.Setting(e).setName("Rating style").setDesc("Emoji stars or classic symbols.").addDropdown(s=>{s.addOption("emoji","Emoji (\u2B50)"),s.addOption("classic","Classic (\u2605)"),s.setValue(r.ratingStyle),s.onChange(async t=>{this.plugin.settings.ratingStyle=t,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Allow half stars").setDesc("If enabled, 3.5 can render as 3 and a half.").addToggle(s=>{s.setValue(r.allowHalfStars),s.onChange(async t=>{this.plugin.settings.allowHalfStars=t,await this.plugin.saveSettings()})})}renderFeatures(e){e.createEl("h3",{text:"Features"});let r=this.plugin.settings;new g.Setting(e).setName("Create series pages").setDesc("Optional, not implemented yet (placeholder).").addToggle(s=>{s.setValue(r.createSeriesPages),s.onChange(async t=>{this.plugin.settings.createSeriesPages=t,await this.plugin.saveSettings()})}),e.createEl("h4",{text:"Creation behavior"}),new g.Setting(e).setName("Open created file automatically").addToggle(s=>{s.setValue(r.openCreatedFile),s.onChange(async t=>{this.plugin.settings.openCreatedFile=t,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Overwrite if exists").setDesc("If a file already exists, replace it.").addToggle(s=>{s.setValue(r.overwriteIfExists),s.onChange(async t=>{this.plugin.settings.overwriteIfExists=t,await this.plugin.saveSettings()})})}renderTags(e){e.createEl("h3",{text:"Tags & Category Rules"});let r=this.plugin.settings,s=O(r.tagRulesJson);s.error&&e.createEl("p",{text:`JSON error: ${s.error}`}),new g.Setting(e).setName("Tag rules (JSON)").setDesc("Controls base tags and per-category tags.").addTextArea(t=>{t.setValue(r.tagRulesJson),t.inputEl.rows=14,t.onChange(async n=>{this.plugin.settings.tagRulesJson=n,await this.plugin.saveSettings()})})}renderAdvanced(e){e.createEl("h3",{text:"Advanced / Importers"}),e.createEl("p",{text:"Coming soon: batch import from library and wishlist pages."})}};function f(a){let e=(a??"").trim();if(!e)return"";try{let r=new URL(e);return r.search="",r.hash="",r.toString()}catch{return e.split("?")[0].split("#")[0]}}function m(a){return(a??"").replace(/\u00A0|\u202F|\u2009/g," ").replace(/\s+/g," ").trim()}function j(a){let e=m(a);return e=e.split(":").join(" - "),e=e.split("&").join(" and "),e=e.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),e=m(e),e=e.replace(/[. ]+$/g,"").trim(),e.length>180&&(e=e.slice(0,180).trim()),e}function P(a){let e=new Set,r=[];for(let s of a){let t=(s??"").trim();t&&(e.has(t)||(e.add(t),r.push(t)))}return r}function A(a){let e=m(a).replace(/&amp;/g,"&");if(!e)return[];let s=e.replace(/\s*(,|\||\/|•|·)\s*/g,",").replace(/\s*&\s*/g," & ").split(",").map(n=>n.trim()).filter(Boolean),t=[];for(let n of s){let o=n.includes(" & ")?n.split(" & ").map(i=>i.trim()).filter(Boolean):[n];for(let i of o){let l=i.replace(/[^\w\s-]/g,"").trim();if(!l)continue;let d=l.split(/\s+/).map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join("");d&&t.push(d)}}return P(t)}function L(a){let e=(a??"").trim();if(!e)return"";let r=e.startsWith("/")?`https://www.audible.com${e}`:e;return f(r)}function U(a){return new DOMParser().parseFromString(a,"text/html")}function H(a){let e=[],r=Array.from(a.querySelectorAll('script[type="application/ld+json"]'));for(let s of r){let t=(s.textContent??"").trim();if(t)try{let n=JSON.parse(t);if(Array.isArray(n))for(let o of n)o&&typeof o=="object"&&e.push(o);else n&&typeof n=="object"&&e.push(n)}catch{}}return e}function V(a){for(let e of a){let r=e?.["@type"];if((Array.isArray(r)?r.map(t=>String(t).toLowerCase()):[String(r??"").toLowerCase()]).some(t=>["book","audiobook","product","creativework"].includes(t)))return e}return a.length?a[0]:null}function $(a,e,r){let s=typeof r?.name=="string"?m(r.name):"",t=typeof r?.url=="string"?f(r.url):"";if(s)return{title:s,url:t||f(e)};let n=a.querySelector('meta[property="og:title"]')?.content??a.querySelector('meta[name="og:title"]')?.content??"";return n?{title:m(n),url:f(e)}:{title:"Unknown Title",url:f(e)}}function J(a,e){let r=e?.image;if(typeof r=="string"&&r.startsWith("http"))return f(r);if(Array.isArray(r)&&typeof r[0]=="string")return f(r[0]);let s=a.querySelector('meta[property="og:image"]')?.content??a.querySelector('meta[name="og:image"]')?.content??"";return s?f(s):""}function _(a,e){let r=typeof e?.description=="string"?m(e.description):"";if(r)return r;let s=a.querySelector('meta[property="og:description"]')?.content??a.querySelector('meta[name="og:description"]')?.content??"";return s?m(s):""}function x(a){let e=new Set,r=[];for(let s of a){let t=m(s.name);if(!t)continue;let n=t.toLowerCase();e.has(n)||(e.add(n),r.push({name:t,url:f(s.url??"")}))}return r}function W(a,e){let r=[],s=(u,y)=>{let w=m(u);w&&r.push({name:w,url:f(y??"")})},t=e?.author;if(Array.isArray(t))for(let u of t)typeof u=="string"?s(u):u&&typeof u=="object"&&s(u.name??"",u.url??"");else t&&typeof t=="object"?s(t.name??"",t.url??""):typeof t=="string"&&s(t);let n=x(r);if(!(n.length===0||n.some(u=>!u.url)))return n;let i=[],l=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]'];for(let u of l)i.push(...Array.from(a.querySelectorAll(u)));let d=Array.from(a.querySelectorAll("div,span,section"));for(let u of d){let y=u.textContent??"";/(\bBy\b|\bWritten by\b|\bAuthor\b)/i.test(y)&&u.querySelector('a[href*="/author/"]')&&i.push(u)}let c=new Map;for(let u of i){let y=Array.from(u.querySelectorAll('a[href*="/author/"]'));for(let w of y){let b=m(w.textContent??"");b&&c.set(b.toLowerCase(),L(w.getAttribute("href")??""))}}if(n.length)return n=n.map(u=>{if(u.url)return u;let y=c.get(u.name.toLowerCase())??"";return{name:u.name,url:f(y)}}),x(n);let h=[];for(let[u,y]of c.entries()){let w=u.replace(/\b\w/g,b=>b.toUpperCase());h.push({name:w,url:f(y)})}return x(h)}function z(a){let e=o=>{let l=m(o).match(/\bBook\s+(\d+)\b/i);return l?l[1]:""},r=a.querySelector('div[data-testid="line"][data-event-id="series"]')||a.querySelector('div[data-testid="line"][key="series"]');if(!r){let o=Array.from(a.querySelectorAll('div[data-testid="line"]'));for(let i of o){let l=i.querySelector(".label");if(m(l?.textContent??"").toLowerCase()==="series"){r=i;break}}}let s="",t="",n="";if(r){let o=r.querySelector('a.link[href*="/series/"]');o&&(s=m(o.textContent??""),t=L(o.getAttribute("href")??"")),n=e(r.textContent??"")}if(!t){let o=a.querySelector('a[href*="/series/"]');if(o){s=m(o.textContent??""),t=L(o.getAttribute("href")??"");let i=o.parentElement;for(let l=0;l<4&&i&&!n;l++)n=e(i.textContent??""),i=i.parentElement}}if(!(!s||!t))return{name:s,url:f(t),book:n??""}}function G(a,e){let r=[],s=Array.from(a.querySelectorAll("adbl-chip-group.product-topictag-impression adbl-chip"));for(let i of s){let l=m(i.textContent??"");l&&r.push(...A(l))}let t=a.querySelector('div[data-testid="line"][key="categories"]');if(t){let i=Array.from(t.querySelectorAll("a.link[href]"));for(let l of i){let d=m(l.textContent??"");d&&r.push(...A(d))}}let n=e?.genre;if(typeof n=="string")r.push(...A(n));else if(Array.isArray(n))for(let i of n)typeof i=="string"&&r.push(...A(i));let o=new Set(["audible","audiobooks","audiobook"]);return r=r.filter(i=>i&&!o.has(i.toLowerCase())),P(r)}async function K(a,e){let r=(e??"").trim();if(!r)throw new Error("Template path is empty.");let s=r.replace(/\\/g,"/").replace(/^\/+/,""),t=a.vault.getAbstractFileByPath(s);if(!t||!(t instanceof p.TFile))throw new Error(`Template not found: ${s}`);return await a.vault.read(t)}function Y(a,e){let r=e.authors.map(h=>h.name).filter(Boolean).join(", "),s=e.authors.length?e.authors.map(h=>h.url?`[${h.name}](${f(h.url)})`:h.name).join(`,  
`):"_Unknown_",t=e.series?.name??"",n=e.series?e.series.url?`[${e.series.name}](${f(e.series.url)})`:e.series.name:"",o=e.series?.book??"",i=e.tags.map(h=>`#${h}`).join(" "),l="["+e.tags.map(h=>JSON.stringify(h)).join(",")+"]",d=a,c=(h,u)=>{d=d.split(h).join(u)};return c("{{type}}",e.type??""),c("{{status}}",e.status??""),c("{{category}}",e.category??""),c("{{acquired}}",e.acquired??""),c("{{source}}",e.source??""),c("{{title}}",e.title??""),c("{{url}}",f(e.url??"")),c("{{cover_url}}",f(e.coverUrl??"")),c("{{authors_md}}",s),c("{{authors_plain}}",r),c("{{series_md}}",n),c("{{series_plain}}",t),c("{{book_md}}",o),c("{{description}}",(e.description??"").trim()),c("{{rating}}",e.rating??""),c("{{tags}}",i),c("{{tags_yaml}}",l),d=d.replace(/\n{4,}/g,`


`),d.trim()+`
`}async function Q(a,e,r){let t=(await(0,p.requestUrl)({url:a,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,n=U(t),o=H(n),i=V(o),{title:l,url:d}=$(n,a,i),c=j(l),h=J(n,i),u=_(n,i),y=W(n,i),w=z(n),b=[],N=JSON.parse(r.tagRulesJson);b.push(...N.baseTags||[]),b.push(...G(n,i));let k=N.categoryTags?.[e.name];return k&&Array.isArray(k)&&b.push(...k),b=P(b),{title:c,url:f(d),coverUrl:h,authors:y,series:w,description:u,category:e.name,status:r.defaultStatus,acquired:r.defaultAcquired,source:r.defaultSource,rating:String(r.defaultRatingNumber),tags:b,type:"book"}}var E=class extends p.Modal{constructor(r,s){super(r);this.url="";this.libraryId="";this.plugin=s,this.libraryId=s.settings.activeLibraryId}async onOpen(){let{contentEl:r}=this;r.empty(),r.createEl("h2",{text:"Create Book from Audible"}),new p.Setting(r).setName("Audible URL").setDesc("Paste the Audible book page URL (https://www.audible.com/pd/...)").addText(s=>{s.setPlaceholder("https://www.audible.com/pd/...").onChange(t=>this.url=t.trim()),s.inputEl.style.width="100%"}),new p.Setting(r).setName("Library").setDesc("Select the target library for this book.").addDropdown(s=>{this.plugin.settings.libraries.forEach(t=>{s.addOption(t.id,t.name)}),s.setValue(this.libraryId),s.onChange(t=>this.libraryId=t)}),new p.Setting(r).addButton(s=>{s.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new p.Notice("Please enter an Audible URL.");return}let t=this.plugin.settings.libraries.find(n=>n.id===this.libraryId);if(!t){new p.Notice("Selected library not found.");return}this.plugin.settings.activeLibraryId!==this.libraryId&&(this.plugin.settings.activeLibraryId=this.libraryId,await this.plugin.saveSettings()),await this.plugin.createBookFromAudible(this.url,t),this.close()}catch(t){console.error(t),new p.Notice(`Failed: ${t?.message??String(t)}`)}})}),new p.Setting(r).addButton(s=>{s.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},v=class extends p.Plugin{async onload(){console.log(`Audible Library Creator v${this.manifest.version} loading...`),await this.loadSettings(),this.addCommand({id:"create-book-from-audible",name:"Create Book from Audible",callback:()=>new E(this.app,this).open()}),this.addSettingTab(new T(this.app,this))}async loadSettings(){this.settings=Object.assign({},D,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createBookFromAudible(e,r){let s=this.settings,t=S(r.booksRoot);this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t),new p.Notice("Fetching Audible page\u2026");let o=await Q(e,r,s),i=await K(this.app,s.bookTemplatePath),l=Y(i,o),d=S(`${t}/${o.title}.md`),c=this.app.vault.getAbstractFileByPath(d);if(c&&c instanceof p.TFile){if(!s.overwriteIfExists){new p.Notice(`File exists: ${d}`),s.openCreatedFile&&await this.app.workspace.getLeaf(!1).openFile(c);return}await this.app.vault.modify(c,l),new p.Notice(`Updated: ${o.title}`)}else await this.app.vault.create(d,l),new p.Notice(`Created: ${o.title}`);if(s.openCreatedFile){let h=this.app.vault.getAbstractFileByPath(d);h&&h instanceof p.TFile&&await this.app.workspace.getLeaf(!1).openFile(h)}}};
