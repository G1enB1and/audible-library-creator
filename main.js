"use strict";var N=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var z=(i,r)=>{for(var s in r)N(i,s,{get:r[s],enumerable:!0})},G=(i,r,s,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of J(r))!W.call(i,e)&&e!==s&&N(i,e,{get:()=>r[e],enumerable:!(t=j(r,e))||t.enumerable});return i};var K=i=>G(N({},"__esModule",{value:!0}),i);var pe={};z(pe,{default:()=>P});module.exports=K(pe);var h=require("obsidian");var y=require("obsidian"),I={bookTemplatePath:"Templates/BookTemplate.md",authorTemplatePath:"Templates/AuthorTemplate.md",seriesTemplatePath:"Templates/SeriesTemplate.md",archiveTemplatePath:"Templates/ArchiveTemplate.md",libraries:[{id:"default",name:"Main Library",booksRoot:"Books",authorsFolder:"Books/Authors",seriesFolder:"Books/Series",archivePath:"Books/Archive/!Archive.md"}],activeLibraryId:"default",defaultCategory:"Fiction",defaultStatus:"",defaultAcquired:"Owned",defaultSource:"Audible",defaultRatingNumber:3,ratingStyle:"classic",allowHalfStars:!0,openCreatedFile:!0,overwriteIfExists:!1,tagRulesJson:JSON.stringify({baseTags:["Book","Audible"],categoryTags:{"Adult Fantasy":["Adult","Fantasy","Erotic"]}},null,2)};function S(i){return(i||"").replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"").trim()}function Y(i){try{let r=JSON.parse(i),s=Array.isArray(r?.baseTags)?r.baseTags.map(String):[],t=r?.categoryTags&&typeof r.categoryTags=="object"?r.categoryTags:{},e={};for(let n of Object.keys(t)){let o=t[n];Array.isArray(o)&&(e[n]=o.map(String))}return{rules:{baseTags:s,categoryTags:e},error:""}}catch(r){return{rules:{baseTags:[],categoryTags:{}},error:r?.message||"Invalid JSON"}}}var L=class extends y.PluginSettingTab{constructor(r,s){super(r,s),this.plugin=s}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:"Audible Library Creator"});let s=[{key:"paths",label:"Paths & Templates"},{key:"defaults",label:"Defaults"},{key:"features",label:"Features"},{key:"tags",label:"Tags & Category Rules"},{key:"advanced",label:"Advanced / Importers"}],t="paths",e=()=>{r.findAll("div.alc-section").forEach(o=>o.remove());let n=r.createDiv({cls:"alc-section"});t==="paths"&&this.renderPaths(n),t==="defaults"&&this.renderDefaults(n),t==="features"&&this.renderFeatures(n),t==="tags"&&this.renderTags(n),t==="advanced"&&this.renderAdvanced(n)};new y.Setting(r).setName("Settings section").setDesc("Choose which settings group to view.").addDropdown(n=>{for(let o of s)n.addOption(o.key,o.label);n.setValue(t),n.onChange(o=>{t=o,e()})}),e()}renderPaths(r){r.createEl("h3",{text:"Templates"});let s=this.plugin.settings,t=(e,n,o)=>{new y.Setting(r).setName(e).setDesc(n).addText(a=>{a.setPlaceholder("Templates/MyTemplate.md"),a.setValue(String(s[o]||"")),a.onChange(async u=>{this.plugin.settings[o]=S(u),await this.plugin.saveSettings()})})};t("Book template path","Template for book notes.","bookTemplatePath"),t("Author template path","Template for Author Notes (Leave blank to disable Author Pages).","authorTemplatePath"),t("Series template path","Template for Series Notes (Leave blank to disable Series Pages).","seriesTemplatePath"),t("Archive template path","Template for archive notes (optional).","archiveTemplatePath"),r.createEl("h3",{text:"Libraries"}),r.createEl("p",{text:"Configure separate paths for different categories/genres. Each library has its own folders for books, authors, and series, and its own archive file."}),s.libraries.forEach((e,n)=>{let o=r.createDiv({cls:"alc-library-item"});o.style.border="1px solid var(--background-modifier-border)",o.style.padding="10px",o.style.marginBottom="10px",o.style.borderRadius="8px",new y.Setting(o).setName(`Library: ${e.name}`).addExtraButton(a=>{a.setIcon("trash").setTooltip("Delete this library").onClick(async()=>{if(s.libraries.length<=1){new Notice("You must have at least one library.");return}s.libraries.splice(n,1),s.activeLibraryId===e.id&&(s.activeLibraryId=s.libraries[0].id),await this.plugin.saveSettings(),this.display()})}),new y.Setting(o).setName("Library name").addText(a=>{a.setValue(e.name),a.onChange(async u=>{e.name=u.trim(),await this.plugin.saveSettings()})}),new y.Setting(o).setName("Books root").setDesc("Where book notes are created.").addText(a=>{a.setValue(e.booksRoot),a.onChange(async u=>{e.booksRoot=S(u),await this.plugin.saveSettings()})}),new y.Setting(o).setName("Authors folder").addText(a=>{a.setValue(e.authorsFolder),a.onChange(async u=>{e.authorsFolder=S(u),await this.plugin.saveSettings()})}),new y.Setting(o).setName("Series folder").addText(a=>{a.setValue(e.seriesFolder),a.onChange(async u=>{e.seriesFolder=S(u),await this.plugin.saveSettings()})}),new y.Setting(o).setName("Archive path").setDesc("Path to the archive .md file.").addText(a=>{a.setValue(e.archivePath),a.onChange(async u=>{e.archivePath=S(u),await this.plugin.saveSettings()})})}),new y.Setting(r).addButton(e=>{e.setButtonText("Add Library").setCta().onClick(async()=>{let n="lib-"+Date.now();s.libraries.push({id:n,name:"New Library",booksRoot:"Books/New",authorsFolder:"Books/New/Authors",seriesFolder:"Books/New/Series",archivePath:"Books/New/!Archive.md"}),await this.plugin.saveSettings(),this.display()})})}renderDefaults(r){r.createEl("h3",{text:"Defaults"});let s=this.plugin.settings;new y.Setting(r).setName("Default category").setDesc("Used when category is not provided in the modal.").addText(t=>{t.setValue(s.defaultCategory||""),t.onChange(async e=>{this.plugin.settings.defaultCategory=e.trim(),await this.plugin.saveSettings()})}),new y.Setting(r).setName("Default status").setDesc("Blank by default is recommended for bulk importing.").addText(t=>{t.setValue(s.defaultStatus||""),t.onChange(async e=>{this.plugin.settings.defaultStatus=e.trim(),await this.plugin.saveSettings()})}),new y.Setting(r).setName("Default acquired").setDesc("Example: Owned, Wish Listed.").addText(t=>{t.setValue(s.defaultAcquired||""),t.onChange(async e=>{this.plugin.settings.defaultAcquired=e.trim(),await this.plugin.saveSettings()})}),new y.Setting(r).setName("Default source").setDesc("Example: Audible.").addText(t=>{t.setValue(s.defaultSource||""),t.onChange(async e=>{this.plugin.settings.defaultSource=e.trim(),await this.plugin.saveSettings()})}),r.createEl("h4",{text:"Rating"}),new y.Setting(r).setName("Default rating number").setDesc("Example: 3 or 3.5").addText(t=>{t.setValue(String(s.defaultRatingNumber)),t.onChange(async e=>{let n=Number(e);Number.isFinite(n)&&(this.plugin.settings.defaultRatingNumber=n,await this.plugin.saveSettings())})}),new y.Setting(r).setName("Rating style").setDesc("Emoji stars or classic symbols.").addDropdown(t=>{t.addOption("emoji","Emoji (\u2B50)"),t.addOption("classic","Classic (\u2605)"),t.setValue(s.ratingStyle),t.onChange(async e=>{this.plugin.settings.ratingStyle=e,await this.plugin.saveSettings()})}),new y.Setting(r).setName("Allow half stars").setDesc("If enabled, 3.5 can render as 3 and a half.").addToggle(t=>{t.setValue(s.allowHalfStars),t.onChange(async e=>{this.plugin.settings.allowHalfStars=e,await this.plugin.saveSettings()})})}renderFeatures(r){r.createEl("h3",{text:"Features"});let s=this.plugin.settings;r.createEl("h4",{text:"Creation behavior"}),new y.Setting(r).setName("Open created file automatically").addToggle(t=>{t.setValue(s.openCreatedFile),t.onChange(async e=>{this.plugin.settings.openCreatedFile=e,await this.plugin.saveSettings()})}),new y.Setting(r).setName("Overwrite if exists").setDesc("If a file already exists, replace it.").addToggle(t=>{t.setValue(s.overwriteIfExists),t.onChange(async e=>{this.plugin.settings.overwriteIfExists=e,await this.plugin.saveSettings()})})}renderTags(r){r.createEl("h3",{text:"Tags & Category Rules"});let s=this.plugin.settings,t=Y(s.tagRulesJson);t.error&&r.createEl("p",{text:`JSON error: ${t.error}`}),new y.Setting(r).setName("Tag rules (JSON)").setDesc("Controls base tags and per-category tags.").addTextArea(e=>{e.setValue(s.tagRulesJson),e.inputEl.rows=14,e.onChange(async n=>{this.plugin.settings.tagRulesJson=n,await this.plugin.saveSettings()})})}renderAdvanced(r){r.createEl("h3",{text:"Advanced / Importers"}),r.createEl("p",{text:"Coming soon: batch import from library and wishlist pages."})}};function b(i){let r=(i??"").trim();if(!r)return"";try{let s=new URL(r,"https://www.audible.com");return s.pathname.includes("/search")||(s.search=""),s.hash="",s.toString()}catch{return r.includes("/search")?r.split("#")[0]:r.split("?")[0].split("#")[0]}}function f(i){return(i??"").replace(/\u00A0|\u202F|\u2009/g," ").replace(/\s+/g," ").trim()}function Q(i){let r=f(i);return r=r.split(":").join(" - "),r=r.split("&").join(" and "),r=r.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),r=f(r),r=r.replace(/[. ]+$/g,"").trim(),r.length>180&&(r=r.slice(0,180).trim()),r}function R(i){let r=new Set,s=[];for(let t of i){let e=(t??"").trim();e&&(r.has(e)||(r.add(e),s.push(e)))}return s}function k(i){let r=f(i).replace(/&amp;/g,"&");if(!r)return[];let t=r.replace(/\s*(,|\||\/|•|·)\s*/g,",").replace(/\s*&\s*/g," & ").split(",").map(n=>n.trim()).filter(Boolean),e=[];for(let n of t){let o=n.includes(" & ")?n.split(" & ").map(a=>a.trim()).filter(Boolean):[n];for(let a of o){let u=a.replace(/[^\w\s-]/g,"").trim();if(!u)continue;let c=u.split(/\s+/).map(g=>g.charAt(0).toUpperCase()+g.slice(1)).join("");c&&e.push(c)}}return R(e)}function C(i){let r=(i??"").trim();if(!r)return"";let s=r.startsWith("/")?`https://www.audible.com${r}`:r;return b(s)}function M(i){return new DOMParser().parseFromString(i,"text/html")}function X(i){let r=[],s=Array.from(i.querySelectorAll('script[type="application/ld+json"]'));for(let t of s){let e=(t.textContent??"").trim();if(e)try{let n=JSON.parse(e);if(Array.isArray(n))for(let o of n)o&&typeof o=="object"&&r.push(o);else n&&typeof n=="object"&&r.push(n)}catch{}}return r}function Z(i){for(let r of i){let s=r?.["@type"];if((Array.isArray(s)?s.map(e=>String(e).toLowerCase()):[String(s??"").toLowerCase()]).some(e=>["book","audiobook","product","creativework"].includes(e)))return r}return i.length?i[0]:null}function T(i,r){let s=Array.from(i.querySelectorAll(r)),t=i.querySelectorAll("template");for(let e=0;e<t.length;e++){let n=t[e];n.content&&s.push(...T(n.content,r))}return s}function ee(i){let r=i.querySelector('adbl-product-metadata script[type="application/json"]');if(!r)return null;try{return JSON.parse(r.textContent??"{}")}catch{return null}}function te(i,r,s){let t=typeof s?.name=="string"?f(s.name):"",e=typeof s?.url=="string"?b(s.url):"";if(t)return{title:t,url:e||b(r)};let n=i.querySelector('meta[property="og:title"]')?.content??i.querySelector('meta[name="og:title"]')?.content??"";return n?{title:f(n),url:b(r)}:{title:"Unknown Title",url:b(r)}}function re(i,r){let s=r?.image;if(typeof s=="string"&&s.startsWith("http"))return b(s);if(Array.isArray(s)&&typeof s[0]=="string")return b(s[0]);let t=i.querySelector('meta[property="og:image"]')?.content??i.querySelector('meta[name="og:image"]')?.content??"";return t?b(t):""}function se(i,r){let s=typeof r?.description=="string"?f(r.description):"";if(s)return s;let t=i.querySelector('meta[property="og:description"]')?.content??i.querySelector('meta[name="og:description"]')?.content??"";return t?f(t):""}function x(i){let r=new Set,s=[];for(let t of i){let e=f(t.name);if(!e)continue;let n=e.toLowerCase();r.has(n)||(r.add(n),s.push({name:e,url:b(t.url??"")}))}return s}function ne(i,r){let s=[],t=(l,d)=>{let m=f(l);m&&s.push({name:m,url:b(d??"")})},e=r?.author;if(Array.isArray(e))for(let l of e)typeof l=="string"?t(l):l&&typeof l=="object"&&t(l.name??"",l.url??"");else e&&typeof e=="object"?t(e.name??"",e.url??""):typeof e=="string"&&t(e);let n=x(s);if(!(n.length===0||n.some(l=>!l.url)))return n;let a=[],u=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]'];for(let l of u)a.push(...T(i,l));let c=T(i,"div,span,section");for(let l of c){let d=l.textContent??"";/(\bBy\b|\bWritten by\b|\bAuthor\b)/i.test(d)&&l.querySelector('a[href*="/author/"]')&&a.push(l)}let g=new Map;for(let l of a){let d=Array.from(l.querySelectorAll('a[href*="/author/"]'));for(let m of d){let A=f(m.textContent??"");A&&g.set(A.toLowerCase(),C(m.getAttribute("href")??""))}}if(n.length)return n=n.map(l=>{if(l.url)return l;let d=g.get(l.name.toLowerCase())??"";return{name:l.name,url:C(d)}}),x(n);let w=[];for(let[l,d]of g.entries()){let m=l.replace(/\b\w/g,A=>A.toUpperCase());w.push({name:m,url:b(d)})}return x(w)}function ae(i,r){let s=[],t=(l,d)=>{let m=f(l);m&&s.push({name:m,url:C(d??"")})},e=r?.readBy??r?.narrator;if(Array.isArray(e))for(let l of e)typeof l=="string"?t(l):l&&typeof l=="object"&&t(l.name??"",l.url??"");else e&&typeof e=="object"?t(e.name??"",e.url??""):typeof e=="string"&&t(e);let n=x(s);if(!(n.length===0||n.some(l=>!l.url)))return n;let a=[],u=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]','[data-testid*="narrator"]','[data-testid="line"]'];for(let l of u)a.push(...T(i,l));let c=T(i,"div,span,section,li");for(let l of c){let d=l.textContent??"";/\bNarrated by\b/i.test(d)&&l.querySelector('a[href*="/narrator/"], a[href*="Narrator"], a[href*="narrator"]')&&a.push(l)}let g=new Map;for(let l of a){let d=Array.from(l.querySelectorAll("a[href]"));for(let m of d){let A=m.getAttribute("href")??"";if(!A.toLowerCase().includes("narrator")&&!A.toLowerCase().includes("search"))continue;let p=f(m.textContent??"");p&&g.set(p.toLowerCase(),C(A))}}if(n.length)return n=n.map(l=>{if(l.url)return l;let d=g.get(l.name.toLowerCase())??"";return{name:l.name,url:C(d)}}),x(n);let w=[];for(let[l,d]of g.entries()){let m=l.replace(/\b\w/g,A=>A.toUpperCase());w.push({name:m,url:C(d)})}return x(w)}function ie(i,r,s){if(r?.duration)return f(r.duration);if(s?.duration){let a=String(s.duration);if(a.startsWith("PT")){let u=a.match(/(\d+)H/)?.[1],c=a.match(/(\d+)M/)?.[1],g="";return u&&(g+=`${u} hrs `),c&&(g+=`${c} mins`),f(g)||a}return f(a)}let e=T(i,'[data-testid="line"]').find(a=>{let u=a.querySelector(".label")?.textContent?.toLowerCase()??"",c=a.getAttribute("data-event-id")?.toLowerCase()??"",g=a.getAttribute("key")?.toLowerCase()??"";return u.includes("length")||u.includes("runtime")||c==="duration"||c==="runtime"||g==="duration"||g==="runtime"});if(!e)return"";let n=e.querySelector(".values .text")?.textContent;if(n)return f(n);let o=e.textContent?.split(":")??[];return f(o[1]??"")}function oe(i,r,s){let t=(u,c)=>({name:f(u),url:C(c??"")}),e="",n="";if(r?.publisher&&(typeof r.publisher=="string"?e=r.publisher:(e=r.publisher.name??"",n=r.publisher.url??"")),e||(s?.publisher?.name?(e=s.publisher.name,n=s.publisher.url??""):typeof s?.publisher=="string"&&(e=s.publisher)),!e){let c=T(i,'[data-testid="line"]').find(g=>{let w=g.querySelector(".label")?.textContent?.toLowerCase()??"",l=g.getAttribute("data-event-id")?.toLowerCase()??"",d=g.getAttribute("key")?.toLowerCase()??"";return w.includes("publisher")||l==="publisher"||d==="publisher"});if(c){let g=c.querySelector("a");if(g)e=g.textContent??"",n=g.getAttribute("href")??"";else{let w=c.querySelector(".values .text")?.textContent;if(w)e=w;else{let l=c.textContent?.split(":")??[];l[1]&&(e=l[1])}}}}if(e=f(e),n=C(n),!e)return t("Unknown Publisher");if(n)return t(e,n);let o=T(i,"a[href]");for(let u of o){let c=u.getAttribute("href")??"",g=f(u.textContent??"");if(g.toLowerCase()===e.toLowerCase()||c.toLowerCase().includes("search")&&(c.toLowerCase().includes("provider")||c.toLowerCase().includes("publisher"))&&(g.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(g.toLowerCase())))return t(e,c)}let a=`https://www.audible.com/search?searchProvider=${encodeURIComponent(e)}`;return t(e,a)}function le(i,r,s){if(r?.releaseDate)return f(r.releaseDate);if(s?.datePublished)return f(s.datePublished);let e=T(i,'[data-testid="line"]').find(a=>{let u=a.querySelector(".label")?.textContent?.toLowerCase()??"",c=a.getAttribute("data-event-id")?.toLowerCase()??"",g=a.getAttribute("key")?.toLowerCase()??"";return u.includes("release date")||c==="releasedate"||g==="releasedate"});if(!e)return"";let n=e.querySelector(".values .text")?.textContent;if(n)return f(n);let o=e.textContent?.split(":")??[];return f(o[1]??"")}function ue(i){let r=o=>{let u=f(o).match(/\bBook\s+(\d+)\b/i);return u?u[1]:""},s=i.querySelector('div[data-testid="line"][data-event-id="series"]')||i.querySelector('div[data-testid="line"][key="series"]');if(!s){let o=Array.from(i.querySelectorAll('div[data-testid="line"]'));for(let a of o){let u=a.querySelector(".label");if(f(u?.textContent??"").toLowerCase()==="series"){s=a;break}}}let t="",e="",n="";if(s){let o=s.querySelector('a.link[href*="/series/"]');o&&(t=f(o.textContent??""),e=C(o.getAttribute("href")??"")),n=r(s.textContent??"")}if(!e){let o=i.querySelector('a[href*="/series/"]');if(o){t=f(o.textContent??""),e=C(o.getAttribute("href")??"");let a=o.parentElement;for(let u=0;u<4&&a&&!n;u++)n=r(a.textContent??""),a=a.parentElement}}if(!(!t||!e))return{name:t,url:b(e),book:n??""}}function ce(i,r){let s=[],t=Array.from(i.querySelectorAll("adbl-chip-group.product-topictag-impression adbl-chip"));for(let a of t){let u=f(a.textContent??"");u&&s.push(...k(u))}let e=i.querySelector('div[data-testid="line"][key="categories"]');if(e){let a=Array.from(e.querySelectorAll("a.link[href]"));for(let u of a){let c=f(u.textContent??"");c&&s.push(...k(c))}}let n=r?.genre;if(typeof n=="string")s.push(...k(n));else if(Array.isArray(n))for(let a of n)typeof a=="string"&&s.push(...k(a));let o=new Set(["audible","audiobooks","audiobook"]);return s=s.filter(a=>a&&!o.has(a.toLowerCase())),R(s)}async function U(i,r){let s=(r??"").trim();if(!s)throw new Error("Template path is empty.");let t=s.replace(/\\/g,"/").replace(/^\/+/,""),e=i.vault.getAbstractFileByPath(t);if(!e||!(e instanceof h.TFile))throw new Error(`Template not found: ${t}`);return await i.vault.read(e)}function $(i,r){let s=i,t=(e,n)=>{s=s.split(e).join(n)};if("title"in r){let e=r,n=e.authors.map(p=>p.name).filter(Boolean).join(", "),o=e.authors_md_override??(e.authors.length?e.authors.map(p=>p.url?`[${p.name}](${b(p.url)})`:p.name).join(`,  
`):"_Unknown_"),a=(e.narrators??[]).map(p=>p.name).filter(Boolean).join(", "),u=(e.narrators??[]).length?(e.narrators??[]).map(p=>p.url?`[${p.name}](${b(p.url)})`:p.name).join(`,  
`):"_Unknown_",c=e.series?.name??"",g=e.series?e.series.url?`[${e.series.name}](${b(e.series.url)})`:e.series.name:"",w=e.series?.book??"",l=e.publisher?.name??"",d=e.publisher?e.publisher.url?`[${e.publisher.name}](${b(e.publisher.url)})`:e.publisher.name:"",m=e.tags.map(p=>`#${p}`).join(" "),A="["+e.tags.map(p=>JSON.stringify(p)).join(",")+"]";t("{{title}}",e.title??""),t("{{cover_url}}",b(e.coverUrl??"")),t("{{authors_md}}",o),t("{{authors_plain}}",n),t("{{narrators_md}}",u),t("{{narrators_plain}}",a),t("{{length}}",e.length??""),t("{{publisher}}",d),t("{{publisher_plain}}",l),t("{{release_date}}",e.releaseDate??""),t("{{start_date}}",e.startDate??""),t("{{finish_date}}",e.finishDate??""),t("{{series_md}}",g),t("{{series_plain}}",c),t("{{book_md}}",w),t("{{tags}}",m),t("{{tags_yaml}}",A),t("{{status}}",e.status??""),t("{{acquired}}",e.acquired??""),t("{{source}}",e.source??"")}else{let e=r;t("{{author_plain}}",e.author),t("{{author_md}}",`[[${e.author}]]`),t("{{image_url}}",b(e.imageUrl??""))}return t("{{type}}",r.type??""),t("{{category}}",r.category??""),t("{{url}}",b(r.url??"")),t("{{description}}",(r.description??"").trim()),t("{{rating}}",r.rating??""),s=s.replace(/\n{4,}/g,`


`),s.trim()+`
`}async function ge(i,r,s,t,e){let o=(await(0,h.requestUrl)({url:i,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,a=M(o),u=X(a),c=Z(u),{title:g,url:w}=te(a,i,c),l=Q(g),d=re(a,c),m=se(a,c),A=ne(a,c),p=ee(a),E=ae(a,c),O=ue(a),_=ie(a,p,c),H=oe(a,p,c),V=le(a,p,c),v=[],B=JSON.parse(s.tagRulesJson);v.push(...B.baseTags||[]),v.push(...ce(a,c));let D=B.categoryTags?.[r.name];return D&&Array.isArray(D)&&v.push(...D),v=R(v),{title:l,url:b(w),coverUrl:d,authors:A,narrators:E,series:O,length:_,publisher:H,releaseDate:V,startDate:"",finishDate:"",description:m,category:r.name,status:t??s.defaultStatus,acquired:s.defaultAcquired,source:s.defaultSource,rating:e??String(s.defaultRatingNumber),tags:v,type:"book"}}async function he(i,r,s,t){let n=(await(0,h.requestUrl)({url:i,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,o=M(n),a=o.querySelector("h1")?.textContent?.trim()??"Unknown Author",u=o.querySelector("img.author-profile-picture")?.getAttribute("src")??"";u||(u=o.querySelector("meta[property='og:image']")?.getAttribute("content")??"");let c=o.querySelector(".bc-expander-content")?.textContent?.trim()??o.querySelector(".author-description")?.textContent?.trim()??o.querySelector("#author-biography")?.textContent?.trim()??o.querySelector(".author-biography-text")?.textContent?.trim()??o.querySelector(".a-spacing-small .a-size-medium")?.textContent?.trim()??"";return{author:a,url:b(i),imageUrl:u,category:r.name,rating:t??String(s.defaultRatingNumber),description:c,type:"author"}}var F=class extends h.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.status="";this.rating="";this.overwriteOverride=!1;this.createAuthorPage=!1;this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.status=t.settings.defaultStatus,this.rating=String(t.settings.defaultRatingNumber)}async onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Book from Audible"}),new h.Setting(s).setName("Audible URL").setDesc("Paste the Audible book page URL (https://www.audible.com/pd/...)").addText(t=>{t.setPlaceholder("https://www.audible.com/pd/...").onChange(e=>this.url=e.trim()),t.inputEl.style.width="100%"}),new h.Setting(s).setName("Library").setDesc("Select the target library for this book.").addDropdown(t=>{this.plugin.settings.libraries.forEach(e=>{t.addOption(e.id,e.name)}),t.setValue(this.libraryId),t.onChange(e=>this.libraryId=e)}),new h.Setting(s).setName("Status").addText(t=>{t.setValue(this.status).onChange(e=>this.status=e.trim()),t.inputEl.style.width="100%"}),new h.Setting(s).setName("Rating").setDesc("Numeric rating (e.g. 3 or 4.5)").addText(t=>{t.setValue(this.rating).onChange(e=>this.rating=e.trim()),t.inputEl.style.width="100%"}),new h.Setting(s).setName("Overwrite Existing Book").addToggle(t=>{t.setValue(this.overwriteOverride).onChange(e=>this.overwriteOverride=e)}),this.plugin.settings.authorTemplatePath&&new h.Setting(s).setName("Create Author's Page").setDesc("Automatically create or update the author's reference page.").addToggle(t=>{t.setValue(this.createAuthorPage).onChange(e=>this.createAuthorPage=e)}),new h.Setting(s).addButton(t=>{t.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new h.Notice("Please enter an Audible URL.");return}let e=this.plugin.settings.libraries.find(n=>n.id===this.libraryId);if(!e){new h.Notice("Selected library not found.");return}this.plugin.settings.activeLibraryId!==this.libraryId&&(this.plugin.settings.activeLibraryId=this.libraryId,await this.plugin.saveSettings()),await this.plugin.createBookFromAudible(this.url,e,this.status,this.rating,this.overwriteOverride,this.createAuthorPage),this.close()}catch(e){console.error(e),new h.Notice(`Failed: ${e?.message??String(e)}`)}})}),new h.Setting(s).addButton(t=>{t.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},q=class extends h.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.rating="";this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.rating=String(t.settings.defaultRatingNumber)}async onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Author from Audible"}),new h.Setting(s).setName("Audible URL").setDesc("Paste the Audible author page URL").addText(t=>{t.setPlaceholder("https://www.audible.com/author/...").onChange(e=>this.url=e.trim()),t.inputEl.style.width="100%"}),new h.Setting(s).setName("Library").addDropdown(t=>{this.plugin.settings.libraries.forEach(e=>{t.addOption(e.id,e.name)}),t.setValue(this.libraryId),t.onChange(e=>this.libraryId=e)}),new h.Setting(s).setName("Rating").addText(t=>{t.setValue(this.rating).onChange(e=>this.rating=e.trim()),t.inputEl.style.width="100%"}),new h.Setting(s).addButton(t=>{t.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new h.Notice("Please enter an Audible URL.");return}let e=this.plugin.settings.libraries.find(n=>n.id===this.libraryId);if(!e){new h.Notice("Selected library not found.");return}await this.plugin.createAuthorFromAudible(this.url,e,this.rating),this.close()}catch(e){console.error(e),new h.Notice(`Failed: ${e?.message??String(e)}`)}})}),new h.Setting(s).addButton(t=>{t.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},P=class extends h.Plugin{async onload(){console.log(`Audible Library Creator v${this.manifest.version} loading...`),await this.loadSettings(),this.addCommand({id:"create-book-from-audible",name:"Create Book from Audible",callback:()=>new F(this.app,this).open()}),this.addCommand({id:"create-author-from-audible",name:"Create Author from Audible",callback:()=>new q(this.app,this).open()}),this.addSettingTab(new L(this.app,this))}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createBookFromAudible(r,s,t,e,n,o){let a=this.settings,u=S(s.booksRoot);this.app.vault.getAbstractFileByPath(u)||await this.app.vault.createFolder(u),new h.Notice("Fetching Audible page\u2026");let g=await ge(r,s,a,t,e);if(o&&a.authorTemplatePath&&g.authors?.length){for(let p of g.authors)if(p.url){let E=p.url.startsWith("http")?p.url:`https://www.audible.com${p.url}`;await this.createAuthorFromAudible(E,s)}g.authors_md_override=g.authors.map(p=>`[[${p.name}]]`).join(`,  
`)}let w=await U(this.app,a.bookTemplatePath),l=$(w,g),d=S(`${u}/${g.title}.md`),m=this.app.vault.getAbstractFileByPath(d),A=n??a.overwriteIfExists;if(m&&m instanceof h.TFile){if(!A){new h.Notice(`File exists: ${d}`),a.openCreatedFile&&await this.app.workspace.getLeaf(!1).openFile(m);return}await this.app.vault.modify(m,l),new h.Notice(`Updated: ${g.title}`)}else await this.app.vault.create(d,l),new h.Notice(`Created: ${g.title}`);if(a.openCreatedFile){let p=this.app.vault.getAbstractFileByPath(d);p&&p instanceof h.TFile&&await this.app.workspace.getLeaf(!1).openFile(p)}}async createAuthorFromAudible(r,s,t){let e=this.settings,n=S(s.authorsFolder);this.app.vault.getAbstractFileByPath(n)||await this.app.vault.createFolder(n),new h.Notice("Fetching Audible author page\u2026");let a=await he(r,s,e,t),u=await U(this.app,e.authorTemplatePath),c=$(u,a),g=S(`${n}/${a.author}.md`),w=this.app.vault.getAbstractFileByPath(g);if(w&&w instanceof h.TFile){if(!e.overwriteIfExists){new h.Notice(`File exists: ${g}`);return}await this.app.vault.modify(w,c),new h.Notice(`Updated Author: ${a.author}`)}else await this.app.vault.create(g,c),new h.Notice(`Created Author: ${a.author}`);if(e.openCreatedFile){let l=this.app.vault.getAbstractFileByPath(g);l&&l instanceof h.TFile&&await this.app.workspace.getLeaf(!1).openFile(l)}}};
