"use strict";var U=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var Z=(i,r)=>{for(var s in r)U(i,s,{get:r[s],enumerable:!0})},ee=(i,r,s,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of Q(r))!X.call(i,e)&&e!==s&&U(i,e,{get:()=>r[e],enumerable:!(t=K(r,e))||t.enumerable});return i};var te=i=>ee(U({},"__esModule",{value:!0}),i);var fe={};Z(fe,{default:()=>q});module.exports=te(fe);var g=require("obsidian");var w=require("obsidian"),z={bookTemplatePath:"Templates/BookTemplate.md",authorTemplatePath:"Templates/AuthorTemplate.md",seriesTemplatePath:"Templates/SeriesTemplate.md",archiveTemplatePath:"Templates/ArchiveTemplate.md",libraries:[{id:"default",name:"Main Library",booksRoot:"Books",authorsFolder:"Books/Authors",seriesFolder:"Books/Series",archivePath:"Books/Archive/!Archive.md"}],activeLibraryId:"default",defaultCategory:"Fiction",defaultStatus:"",defaultAcquired:"Owned",defaultSource:"Audible",defaultRatingNumber:3,ratingStyle:"classic",allowHalfStars:!0,openCreatedFile:!0,overwriteIfExists:!1,tagRulesJson:JSON.stringify({baseTags:["Book","Audible"],categoryTags:{"Adult Fantasy":["Adult","Fantasy","Erotic"]}},null,2)};function S(i){return(i||"").replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"").trim()}function se(i){try{let r=JSON.parse(i),s=Array.isArray(r?.baseTags)?r.baseTags.map(String):[],t=r?.categoryTags&&typeof r.categoryTags=="object"?r.categoryTags:{},e={};for(let n of Object.keys(t)){let o=t[n];Array.isArray(o)&&(e[n]=o.map(String))}return{rules:{baseTags:s,categoryTags:e},error:""}}catch(r){return{rules:{baseTags:[],categoryTags:{}},error:r?.message||"Invalid JSON"}}}var D=class extends w.PluginSettingTab{constructor(r,s){super(r,s),this.plugin=s}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:"Audible Library Creator"});let s=[{key:"paths",label:"Paths & Templates"},{key:"defaults",label:"Defaults"},{key:"features",label:"Features"},{key:"tags",label:"Tags & Category Rules"},{key:"advanced",label:"Advanced / Importers"}],t="paths",e=()=>{r.findAll("div.alc-section").forEach(o=>o.remove());let n=r.createDiv({cls:"alc-section"});t==="paths"&&this.renderPaths(n),t==="defaults"&&this.renderDefaults(n),t==="features"&&this.renderFeatures(n),t==="tags"&&this.renderTags(n),t==="advanced"&&this.renderAdvanced(n)};new w.Setting(r).setName("Settings section").setDesc("Choose which settings group to view.").addDropdown(n=>{for(let o of s)n.addOption(o.key,o.label);n.setValue(t),n.onChange(o=>{t=o,e()})}),e()}renderPaths(r){r.createEl("h3",{text:"Templates"});let s=this.plugin.settings,t=(e,n,o)=>{new w.Setting(r).setName(e).setDesc(n).addText(a=>{a.setPlaceholder("Templates/MyTemplate.md"),a.setValue(String(s[o]||"")),a.onChange(async c=>{this.plugin.settings[o]=S(c),await this.plugin.saveSettings()})})};t("Book template path","Template for book notes.","bookTemplatePath"),t("Author template path","Template for Author Notes (Leave blank to disable Author Pages).","authorTemplatePath"),t("Series template path","Template for Series Notes (Leave blank to disable Series Pages).","seriesTemplatePath"),t("Archive template path","Template for archive notes (optional).","archiveTemplatePath"),r.createEl("h3",{text:"Libraries"}),r.createEl("p",{text:"Configure separate paths for different categories/genres. Each library has its own folders for books, authors, and series, and its own archive file."}),s.libraries.forEach((e,n)=>{let o=r.createDiv({cls:"alc-library-item"});o.style.border="1px solid var(--background-modifier-border)",o.style.padding="10px",o.style.marginBottom="10px",o.style.borderRadius="8px",new w.Setting(o).setName(`Library: ${e.name}`).addExtraButton(a=>{a.setIcon("trash").setTooltip("Delete this library").onClick(async()=>{if(s.libraries.length<=1){new Notice("You must have at least one library.");return}s.libraries.splice(n,1),s.activeLibraryId===e.id&&(s.activeLibraryId=s.libraries[0].id),await this.plugin.saveSettings(),this.display()})}),new w.Setting(o).setName("Library name").addText(a=>{a.setValue(e.name),a.onChange(async c=>{e.name=c.trim(),await this.plugin.saveSettings()})}),new w.Setting(o).setName("Books root").setDesc("Where book notes are created.").addText(a=>{a.setValue(e.booksRoot),a.onChange(async c=>{e.booksRoot=S(c),await this.plugin.saveSettings()})}),new w.Setting(o).setName("Authors folder").addText(a=>{a.setValue(e.authorsFolder),a.onChange(async c=>{e.authorsFolder=S(c),await this.plugin.saveSettings()})}),new w.Setting(o).setName("Series folder").addText(a=>{a.setValue(e.seriesFolder),a.onChange(async c=>{e.seriesFolder=S(c),await this.plugin.saveSettings()})}),new w.Setting(o).setName("Archive path").setDesc("Path to the archive .md file.").addText(a=>{a.setValue(e.archivePath),a.onChange(async c=>{e.archivePath=S(c),await this.plugin.saveSettings()})})}),new w.Setting(r).addButton(e=>{e.setButtonText("Add Library").setCta().onClick(async()=>{let n="lib-"+Date.now();s.libraries.push({id:n,name:"New Library",booksRoot:"Books/New",authorsFolder:"Books/New/Authors",seriesFolder:"Books/New/Series",archivePath:"Books/New/!Archive.md"}),await this.plugin.saveSettings(),this.display()})})}renderDefaults(r){r.createEl("h3",{text:"Defaults"});let s=this.plugin.settings;new w.Setting(r).setName("Default category").setDesc("Used when category is not provided in the modal.").addText(t=>{t.setValue(s.defaultCategory||""),t.onChange(async e=>{this.plugin.settings.defaultCategory=e.trim(),await this.plugin.saveSettings()})}),new w.Setting(r).setName("Default status").setDesc("Blank by default is recommended for bulk importing.").addText(t=>{t.setValue(s.defaultStatus||""),t.onChange(async e=>{this.plugin.settings.defaultStatus=e.trim(),await this.plugin.saveSettings()})}),new w.Setting(r).setName("Default acquired").setDesc("Example: Owned, Wish Listed.").addText(t=>{t.setValue(s.defaultAcquired||""),t.onChange(async e=>{this.plugin.settings.defaultAcquired=e.trim(),await this.plugin.saveSettings()})}),new w.Setting(r).setName("Default source").setDesc("Example: Audible.").addText(t=>{t.setValue(s.defaultSource||""),t.onChange(async e=>{this.plugin.settings.defaultSource=e.trim(),await this.plugin.saveSettings()})}),r.createEl("h4",{text:"Rating"}),new w.Setting(r).setName("Default rating number").setDesc("Example: 3 or 3.5").addText(t=>{t.setValue(String(s.defaultRatingNumber)),t.onChange(async e=>{let n=Number(e);Number.isFinite(n)&&(this.plugin.settings.defaultRatingNumber=n,await this.plugin.saveSettings())})}),new w.Setting(r).setName("Rating style").setDesc("Emoji stars or classic symbols.").addDropdown(t=>{t.addOption("emoji","Emoji (\u2B50)"),t.addOption("classic","Classic (\u2605)"),t.setValue(s.ratingStyle),t.onChange(async e=>{this.plugin.settings.ratingStyle=e,await this.plugin.saveSettings()})}),new w.Setting(r).setName("Allow half stars").setDesc("If enabled, 3.5 can render as 3 and a half.").addToggle(t=>{t.setValue(s.allowHalfStars),t.onChange(async e=>{this.plugin.settings.allowHalfStars=e,await this.plugin.saveSettings()})})}renderFeatures(r){r.createEl("h3",{text:"Features"});let s=this.plugin.settings;r.createEl("h4",{text:"Creation behavior"}),new w.Setting(r).setName("Open created file automatically").addToggle(t=>{t.setValue(s.openCreatedFile),t.onChange(async e=>{this.plugin.settings.openCreatedFile=e,await this.plugin.saveSettings()})}),new w.Setting(r).setName("Overwrite if exists").setDesc("If a file already exists, replace it.").addToggle(t=>{t.setValue(s.overwriteIfExists),t.onChange(async e=>{this.plugin.settings.overwriteIfExists=e,await this.plugin.saveSettings()})})}renderTags(r){r.createEl("h3",{text:"Tags & Category Rules"});let s=this.plugin.settings,t=se(s.tagRulesJson);t.error&&r.createEl("p",{text:`JSON error: ${t.error}`}),new w.Setting(r).setName("Tag rules (JSON)").setDesc("Controls base tags and per-category tags.").addTextArea(e=>{e.setValue(s.tagRulesJson),e.inputEl.rows=14,e.onChange(async n=>{this.plugin.settings.tagRulesJson=n,await this.plugin.saveSettings()})})}renderAdvanced(r){r.createEl("h3",{text:"Advanced / Importers"}),r.createEl("p",{text:"Coming soon: batch import from library and wishlist pages."})}};function y(i){let r=(i??"").trim();if(!r)return"";try{let s=new URL(r,"https://www.audible.com");return s.pathname.includes("/search")||(s.search=""),s.hash="",s.toString()}catch{return r.includes("/search")?r.split("#")[0]:r.split("?")[0].split("#")[0]}}function f(i){return(i??"").replace(/\u00A0|\u202F|\u2009/g," ").replace(/\s+/g," ").trim()}function Y(i){let r=f(i);return r=r.split(":").join(" - "),r=r.split("&").join(" and "),r=r.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),r=f(r),r=r.replace(/[. ]+$/g,"").trim(),r.length>180&&(r=r.slice(0,180).trim()),r}function B(i){let r=new Set,s=[];for(let t of i){let e=(t??"").trim();e&&(r.has(e)||(r.add(e),s.push(e)))}return s}function P(i){let r=f(i).replace(/&amp;/g,"&");if(!r)return[];let t=r.replace(/\s*(,|\||\/|•|·)\s*/g,",").replace(/\s*&\s*/g," & ").split(",").map(n=>n.trim()).filter(Boolean),e=[];for(let n of t){let o=n.includes(" & ")?n.split(" & ").map(a=>a.trim()).filter(Boolean):[n];for(let a of o){let c=a.replace(/[^\w\s-]/g,"").trim();if(!c)continue;let d=c.split(/\s+/).map(u=>u.charAt(0).toUpperCase()+u.slice(1)).join("");d&&e.push(d)}}return B(e)}function C(i){let r=(i??"").trim();if(!r)return"";let s=r.startsWith("/")?`https://www.audible.com${r}`:r;return y(s)}function j(i){return new DOMParser().parseFromString(i,"text/html")}function _(i){let r=[],s=Array.from(i.querySelectorAll('script[type="application/ld+json"]'));for(let t of s){let e=(t.textContent??"").trim();if(e)try{let n=JSON.parse(e);if(Array.isArray(n))for(let o of n)o&&typeof o=="object"&&r.push(o);else n&&typeof n=="object"&&r.push(n)}catch{}}return r}function V(i){for(let r of i){let s=r?.["@type"];if((Array.isArray(s)?s.map(e=>String(e).toLowerCase()):[String(s??"").toLowerCase()]).some(e=>["book","audiobook","product","creativework"].includes(e)))return r}return i.length?i[0]:null}function T(i,r){let s=Array.from(i.querySelectorAll(r)),t=i.querySelectorAll("template");for(let e=0;e<t.length;e++){let n=t[e];n.content&&s.push(...T(n.content,r))}return s}function re(i){let r=i.querySelector('adbl-product-metadata script[type="application/json"]');if(!r)return null;try{return JSON.parse(r.textContent??"{}")}catch{return null}}function ne(i,r,s){let t=typeof s?.name=="string"?f(s.name):"",e=typeof s?.url=="string"?y(s.url):"";if(t)return{title:t,url:e||y(r)};let n=i.querySelector('meta[property="og:title"]')?.content??i.querySelector('meta[name="og:title"]')?.content??"";return n?{title:f(n),url:y(r)}:{title:"Unknown Title",url:y(r)}}function ae(i,r){let s=r?.image;if(typeof s=="string"&&s.startsWith("http"))return y(s);if(Array.isArray(s)&&typeof s[0]=="string")return y(s[0]);let t=i.querySelector('meta[property="og:image"]')?.content??i.querySelector('meta[name="og:image"]')?.content??"";return t?y(t):""}function H(i,r){let s=typeof r?.description=="string"?f(r.description):"";if(s)return s;let t=i.querySelector('meta[property="og:description"]')?.content??i.querySelector('meta[name="og:description"]')?.content??"";return t?f(t):""}function k(i){let r=new Set,s=[];for(let t of i){let e=f(t.name);if(!e)continue;let n=e.toLowerCase();r.has(n)||(r.add(n),s.push({name:e,url:y(t.url??"")}))}return s}function ie(i,r){let s=[],t=(l,p)=>{let m=f(l);m&&s.push({name:m,url:y(p??"")})},e=r?.author;if(Array.isArray(e))for(let l of e)typeof l=="string"?t(l):l&&typeof l=="object"&&t(l.name??"",l.url??"");else e&&typeof e=="object"?t(e.name??"",e.url??""):typeof e=="string"&&t(e);let n=k(s);if(!(n.length===0||n.some(l=>!l.url)))return n;let a=[],c=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]'];for(let l of c)a.push(...T(i,l));let d=T(i,"div,span,section");for(let l of d){let p=l.textContent??"";/(\bBy\b|\bWritten by\b|\bAuthor\b)/i.test(p)&&l.querySelector('a[href*="/author/"]')&&a.push(l)}let u=new Map;for(let l of a){let p=Array.from(l.querySelectorAll('a[href*="/author/"]'));for(let m of p){let b=f(m.textContent??"");b&&u.set(b.toLowerCase(),C(m.getAttribute("href")??""))}}if(n.length)return n=n.map(l=>{if(l.url)return l;let p=u.get(l.name.toLowerCase())??"";return{name:l.name,url:C(p)}}),k(n);let A=[];for(let[l,p]of u.entries()){let m=l.replace(/\b\w/g,b=>b.toUpperCase());A.push({name:m,url:y(p)})}return k(A)}function oe(i,r){let s=[],t=(l,p)=>{let m=f(l);m&&s.push({name:m,url:C(p??"")})},e=r?.readBy??r?.narrator;if(Array.isArray(e))for(let l of e)typeof l=="string"?t(l):l&&typeof l=="object"&&t(l.name??"",l.url??"");else e&&typeof e=="object"?t(e.name??"",e.url??""):typeof e=="string"&&t(e);let n=k(s);if(!(n.length===0||n.some(l=>!l.url)))return n;let a=[],c=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]','[data-testid*="narrator"]','[data-testid="line"]'];for(let l of c)a.push(...T(i,l));let d=T(i,"div,span,section,li");for(let l of d){let p=l.textContent??"";/\bNarrated by\b/i.test(p)&&l.querySelector('a[href*="/narrator/"], a[href*="Narrator"], a[href*="narrator"]')&&a.push(l)}let u=new Map;for(let l of a){let p=Array.from(l.querySelectorAll("a[href]"));for(let m of p){let b=m.getAttribute("href")??"";if(!b.toLowerCase().includes("narrator")&&!b.toLowerCase().includes("search"))continue;let h=f(m.textContent??"");h&&u.set(h.toLowerCase(),C(b))}}if(n.length)return n=n.map(l=>{if(l.url)return l;let p=u.get(l.name.toLowerCase())??"";return{name:l.name,url:C(p)}}),k(n);let A=[];for(let[l,p]of u.entries()){let m=l.replace(/\b\w/g,b=>b.toUpperCase());A.push({name:m,url:C(p)})}return k(A)}function le(i,r,s){if(r?.duration)return f(r.duration);if(s?.duration){let a=String(s.duration);if(a.startsWith("PT")){let c=a.match(/(\d+)H/)?.[1],d=a.match(/(\d+)M/)?.[1],u="";return c&&(u+=`${c} hrs `),d&&(u+=`${d} mins`),f(u)||a}return f(a)}let e=T(i,'[data-testid="line"]').find(a=>{let c=a.querySelector(".label")?.textContent?.toLowerCase()??"",d=a.getAttribute("data-event-id")?.toLowerCase()??"",u=a.getAttribute("key")?.toLowerCase()??"";return c.includes("length")||c.includes("runtime")||d==="duration"||d==="runtime"||u==="duration"||u==="runtime"});if(!e)return"";let n=e.querySelector(".values .text")?.textContent;if(n)return f(n);let o=e.textContent?.split(":")??[];return f(o[1]??"")}function ce(i,r,s){let t=(c,d)=>({name:f(c),url:C(d??"")}),e="",n="";if(r?.publisher&&(typeof r.publisher=="string"?e=r.publisher:(e=r.publisher.name??"",n=r.publisher.url??"")),e||(s?.publisher?.name?(e=s.publisher.name,n=s.publisher.url??""):typeof s?.publisher=="string"&&(e=s.publisher)),!e){let d=T(i,'[data-testid="line"]').find(u=>{let A=u.querySelector(".label")?.textContent?.toLowerCase()??"",l=u.getAttribute("data-event-id")?.toLowerCase()??"",p=u.getAttribute("key")?.toLowerCase()??"";return A.includes("publisher")||l==="publisher"||p==="publisher"});if(d){let u=d.querySelector("a");if(u)e=u.textContent??"",n=u.getAttribute("href")??"";else{let A=d.querySelector(".values .text")?.textContent;if(A)e=A;else{let l=d.textContent?.split(":")??[];l[1]&&(e=l[1])}}}}if(e=f(e),n=C(n),!e)return t("Unknown Publisher");if(n)return t(e,n);let o=T(i,"a[href]");for(let c of o){let d=c.getAttribute("href")??"",u=f(c.textContent??"");if(u.toLowerCase()===e.toLowerCase()||d.toLowerCase().includes("search")&&(d.toLowerCase().includes("provider")||d.toLowerCase().includes("publisher"))&&(u.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(u.toLowerCase())))return t(e,d)}let a=`https://www.audible.com/search?searchProvider=${encodeURIComponent(e)}`;return t(e,a)}function ue(i,r,s){if(r?.releaseDate)return f(r.releaseDate);if(s?.datePublished)return f(s.datePublished);let e=T(i,'[data-testid="line"]').find(a=>{let c=a.querySelector(".label")?.textContent?.toLowerCase()??"",d=a.getAttribute("data-event-id")?.toLowerCase()??"",u=a.getAttribute("key")?.toLowerCase()??"";return c.includes("release date")||d==="releasedate"||u==="releasedate"});if(!e)return"";let n=e.querySelector(".values .text")?.textContent;if(n)return f(n);let o=e.textContent?.split(":")??[];return f(o[1]??"")}function ge(i){let r=o=>{let c=f(o).match(/\bBook\s+(\d+)\b/i);return c?c[1]:""},s=i.querySelector('div[data-testid="line"][data-event-id="series"]')||i.querySelector('div[data-testid="line"][key="series"]');if(!s){let o=Array.from(i.querySelectorAll('div[data-testid="line"]'));for(let a of o){let c=a.querySelector(".label");if(f(c?.textContent??"").toLowerCase()==="series"){s=a;break}}}let t="",e="",n="";if(s){let o=s.querySelector('a.link[href*="/series/"]');o&&(t=f(o.textContent??""),e=C(o.getAttribute("href")??"")),n=r(s.textContent??"")}if(!e){let o=i.querySelector('a[href*="/series/"]');if(o){t=f(o.textContent??""),e=C(o.getAttribute("href")??"");let a=o.parentElement;for(let c=0;c<4&&a&&!n;c++)n=r(a.textContent??""),a=a.parentElement}}if(!(!t||!e))return{name:t,url:y(e),book:n??""}}function G(i,r){let s=[],t=Array.from(i.querySelectorAll("adbl-chip-group.product-topictag-impression adbl-chip, adbl-chip-group.related-tag-impression adbl-chip"));for(let a of t){let c=f(a.textContent??"");c&&s.push(...P(c))}let e=i.querySelector('div[data-testid="line"][key="categories"]');if(e){let a=Array.from(e.querySelectorAll("a.link[href]"));for(let c of a){let d=f(c.textContent??"");d&&s.push(...P(d))}}let n=r?.genre;if(typeof n=="string")s.push(...P(n));else if(Array.isArray(n))for(let a of n)typeof a=="string"&&s.push(...P(a));let o=new Set(["audible","audiobooks","audiobook"]);return s=s.filter(a=>a&&!o.has(a.toLowerCase())),B(s)}async function $(i,r){let s=(r??"").trim();if(!s)throw new Error("Template path is empty.");let t=s.replace(/\\/g,"/").replace(/^\/+/,""),e=i.vault.getAbstractFileByPath(t);if(!e||!(e instanceof g.TFile))throw new Error(`Template not found: ${t}`);return await i.vault.read(e)}function O(i,r){let s=i,t=(e,n)=>{s=s.split(e).join(n)};if("title"in r){let e=r,n=e.authors.map(h=>h.name).filter(Boolean).join(", "),o=e.authors_md_override??(e.authors.length?e.authors.map(h=>h.url?`[${h.name}](${y(h.url)})`:h.name).join(`,  
`):"_Unknown_"),a=(e.narrators??[]).map(h=>h.name).filter(Boolean).join(", "),c=(e.narrators??[]).length?(e.narrators??[]).map(h=>h.url?`[${h.name}](${y(h.url)})`:h.name).join(`,  
`):"_Unknown_",d=e.series?.name??"",u=e.series?e.series.url?`[${e.series.name}](${y(e.series.url)})`:e.series.name:"",A=e.series?.book??"",l=e.publisher?.name??"",p=e.publisher?e.publisher.url?`[${e.publisher.name}](${y(e.publisher.url)})`:e.publisher.name:"",m=e.tags.map(h=>`#${h}`).join(" "),b="["+e.tags.map(h=>JSON.stringify(h)).join(",")+"]";t("{{title}}",e.title??""),t("{{cover_url}}",y(e.coverUrl??"")),t("{{authors_md}}",o),t("{{authors_plain}}",n),t("{{narrators_md}}",c),t("{{narrators_plain}}",a),t("{{length}}",e.length??""),t("{{publisher}}",p),t("{{publisher_plain}}",l),t("{{release_date}}",e.releaseDate??""),t("{{start_date}}",e.startDate??""),t("{{finish_date}}",e.finishDate??""),t("{{series_md}}",u),t("{{series_plain}}",d),t("{{book_md}}",A),t("{{tags}}",m),t("{{tags_yaml}}",b),t("{{status}}",e.status??""),t("{{acquired}}",e.acquired??""),t("{{source}}",e.source??"")}else if("series"in r&&!("title"in r)){let e=r,n=e.tags.map(a=>`#${a}`).join(" "),o="["+e.tags.map(a=>JSON.stringify(a)).join(",")+"]";t("{{series}}",e.series??""),t("{{Series}}",e.series??""),t("{{books}}",e.books??""),t("{{category}}",e.category??""),t("{{tags}}",n),t("{{tags_yaml}}",o)}else{let e=r;t("{{author_plain}}",e.author),t("{{author_md}}",`[[${e.author}]]`),t("{{image_url}}",y(e.imageUrl??""))}return t("{{type}}",r.type??""),t("{{category}}",r.category??""),t("{{url}}",y(r.url??"")),t("{{description}}",(r.description??"").trim()),t("{{rating}}",r.rating??""),s=s.replace(/\n{4,}/g,`


`),s.trim()+`
`}async function de(i,r,s,t,e){let o=(await(0,g.requestUrl)({url:i,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,a=j(o),c=_(a),d=V(c),{title:u,url:A}=ne(a,i,d),l=Y(u),p=ae(a,d),m=H(a,d),b=ie(a,d),h=re(a),v=oe(a,d),x=ge(a),R=le(a,h,d),J=ce(a,h,d),E=ue(a,h,d),L=[],W=JSON.parse(s.tagRulesJson);L.push(...W.baseTags||[]),L.push(...G(a,d));let I=W.categoryTags?.[r.name];return I&&Array.isArray(I)&&L.push(...I),L=B(L),{title:l,url:y(A),coverUrl:p,authors:b,narrators:v,series:x,length:R,publisher:J,releaseDate:E,startDate:"",finishDate:"",description:m,category:r.name,status:t??s.defaultStatus,acquired:s.defaultAcquired,source:s.defaultSource,rating:e??String(s.defaultRatingNumber),tags:L,type:"book"}}async function he(i,r,s,t){let n=(await(0,g.requestUrl)({url:i,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,o=j(n),a=_(o),c=V(a),d=o.querySelector("h1")?.textContent?.trim()??"Unknown Author",u=o.querySelector("img.author-profile-picture")?.getAttribute("src")??"";return u||(u=o.querySelector("meta[property='og:image']")?.getAttribute("content")??""),{author:d,url:y(i),imageUrl:y(u),category:"Author",rating:t??"0",description:H(o,c),type:"Author"}}async function pe(i,r,s,t){let n=(await(0,g.requestUrl)({url:i,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,o=j(n),a=_(o),c=V(a),d=f(o.querySelector("h1")?.textContent??""),u="",A=[o.querySelector(".series-summary-content"),o.querySelector("#series-description .bc-section"),o.querySelector('[data-widget="description"] .bc-text'),o.querySelector('[data-testid="description"]'),o.querySelector(".series-description"),o.querySelector(".bc-expander-content")];for(let h of A)if(h&&(u=f(h.textContent??""),u&&!u.includes("Listen to")&&!u.includes("Audiobooks on Audible")))break;u||(u=H(o,c));let l=G(o,c);if(l.length===0){let h=o.querySelectorAll(".bc-chip");for(let v of Array.from(h)){let x=f(v.textContent??"");x&&l.push(...P(x))}}l=B(l);let p=s,m=o.querySelector(".num-books-in-series"),b="0";if(m){let h=m.textContent?.match(/(\d+)/);h&&(b=h[1])}if(b==="0"){let h=o.querySelector('#series-results, [data-widget="product-list"]'),v=h?T(h,'li.bc-list-item, [data-testid="product-list-item"]'):[];if(v.length>0)b=v.length.toString();else{let x=o.querySelectorAll(".bc-text, .bc-heading");for(let R of Array.from(x)){let E=(R.textContent??"").match(/(\d+)\s+titles/);if(E){b=E[1];break}}}}return{series:d,url:y(i),books:b,description:u,category:p,rating:t??"0",tags:l,type:"Series"}}var N=class extends g.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.status="";this.rating="";this.overwriteOverride=!1;this.createAuthorPage=!1;this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.status=t.settings.defaultStatus,this.rating=String(t.settings.defaultRatingNumber)}async onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Book from Audible"}),new g.Setting(s).setName("Audible URL").setDesc("Paste the Audible book page URL (https://www.audible.com/pd/...)").addText(t=>{t.setPlaceholder("https://www.audible.com/pd/...").onChange(e=>this.url=e.trim()),t.inputEl.style.width="100%"}),new g.Setting(s).setName("Library").setDesc("Select the target library for this book.").addDropdown(t=>{this.plugin.settings.libraries.forEach(e=>{t.addOption(e.id,e.name)}),t.setValue(this.libraryId),t.onChange(e=>this.libraryId=e)}),new g.Setting(s).setName("Status").addText(t=>{t.setValue(this.status).onChange(e=>this.status=e.trim()),t.inputEl.style.width="100%"}),new g.Setting(s).setName("Rating").setDesc("Numeric rating (e.g. 3 or 4.5)").addText(t=>{t.setValue(this.rating).onChange(e=>this.rating=e.trim()),t.inputEl.style.width="100%"}),new g.Setting(s).setName("Overwrite Existing Book").addToggle(t=>{t.setValue(this.overwriteOverride).onChange(e=>this.overwriteOverride=e)}),this.plugin.settings.authorTemplatePath&&new g.Setting(s).setName("Create Author's Page").setDesc("Automatically create or update the author's reference page.").addToggle(t=>{t.setValue(this.createAuthorPage).onChange(e=>this.createAuthorPage=e)}),new g.Setting(s).addButton(t=>{t.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new g.Notice("Please enter an Audible URL.");return}let e=this.plugin.settings.libraries.find(n=>n.id===this.libraryId);if(!e){new g.Notice("Selected library not found.");return}this.plugin.settings.activeLibraryId!==this.libraryId&&(this.plugin.settings.activeLibraryId=this.libraryId,await this.plugin.saveSettings()),await this.plugin.createBookFromAudible(this.url,e,this.status,this.rating,this.overwriteOverride,this.createAuthorPage),this.close()}catch(e){console.error(e),new g.Notice(`Failed: ${e?.message??String(e)}`)}})}),new g.Setting(s).addButton(t=>{t.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},M=class extends g.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.rating="";this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.rating=String(t.settings.defaultRatingNumber)}async onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Author from Audible"}),new g.Setting(s).setName("Audible URL").setDesc("Paste the Audible author page URL").addText(t=>{t.setPlaceholder("https://www.audible.com/author/...").onChange(e=>this.url=e.trim()),t.inputEl.style.width="100%"}),new g.Setting(s).setName("Library").addDropdown(t=>{this.plugin.settings.libraries.forEach(e=>{t.addOption(e.id,e.name)}),t.setValue(this.libraryId),t.onChange(e=>this.libraryId=e)}),new g.Setting(s).setName("Rating").addText(t=>{t.setValue(this.rating).onChange(e=>this.rating=e.trim()),t.inputEl.style.width="100%"}),new g.Setting(s).addButton(t=>{t.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new g.Notice("Please enter an Audible URL.");return}let e=this.plugin.settings.libraries.find(n=>n.id===this.libraryId);if(!e){new g.Notice("Selected library not found.");return}await this.plugin.createAuthorFromAudible(this.url,e,this.rating),this.close()}catch(e){console.error(e),new g.Notice(`Failed: ${e?.message??String(e)}`)}})}),new g.Setting(s).addButton(t=>{t.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},F=class extends g.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.rating="";this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.rating=String(t.settings.defaultRatingNumber)}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Series Page from Audible"}),new g.Setting(s).setName("Audible Series URL").setDesc("Paste the Audible series page URL").addText(t=>{t.setPlaceholder("https://www.audible.com/series/...").onChange(e=>this.url=e.trim()),t.inputEl.style.width="100%"}),new g.Setting(s).setName("Library").setDesc("Select the target library for this series.").addDropdown(t=>{this.plugin.settings.libraries.forEach(e=>{t.addOption(e.id,e.name)}),t.setValue(this.libraryId),t.onChange(e=>this.libraryId=e)}),new g.Setting(s).setName("Rating").setDesc("Numeric rating (e.g. 3 or 4.5)").addText(t=>{t.setValue(this.rating).onChange(e=>this.rating=e.trim()),t.inputEl.style.width="100%"}),new g.Setting(s).addButton(t=>t.setButtonText("Create Series Page").setCta().onClick(async()=>{if(!this.url){new g.Notice("Please enter a URL.");return}let e=this.plugin.settings.libraries.find(n=>n.id===this.libraryId);e&&(this.close(),await this.plugin.createSeriesFromAudible(this.url,e,this.rating))}))}onClose(){this.contentEl.empty()}},q=class extends g.Plugin{async onload(){console.log(`Audible Library Creator v${this.manifest.version} loading...`),await this.loadSettings(),this.addRibbonIcon("book-open","Add Audible Book",()=>{new N(this.app,this).open()}),this.addRibbonIcon("library","Add Audible Series",()=>{new F(this.app,this).open()}),this.addCommand({id:"add-audible-book",name:"Add Audible Book",callback:()=>new N(this.app,this).open()}),this.addCommand({id:"add-audible-author",name:"Add Audible Author",callback:()=>new M(this.app,this).open()}),this.addCommand({id:"add-audible-series",name:"Add Audible Series",callback:()=>new F(this.app,this).open()}),this.addSettingTab(new D(this.app,this))}async loadSettings(){this.settings=Object.assign({},z,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createBookFromAudible(r,s,t,e,n,o){let a=this.settings,c=S(s.booksRoot);this.app.vault.getAbstractFileByPath(c)||await this.app.vault.createFolder(c),new g.Notice("Fetching Audible page\u2026");let u=await de(r,s,a,t,e);if(o&&a.authorTemplatePath&&u.authors?.length){for(let h of u.authors)if(h.url){let v=h.url.startsWith("http")?h.url:`https://www.audible.com${h.url}`;await this.createAuthorFromAudible(v,s)}u.authors_md_override=u.authors.map(h=>`[[${h.name}]]`).join(`,  
`)}let A=await $(this.app,a.bookTemplatePath),l=O(A,u),p=S(`${c}/${u.title}.md`),m=this.app.vault.getAbstractFileByPath(p),b=n??a.overwriteIfExists;if(m&&m instanceof g.TFile){if(!b){new g.Notice(`File exists: ${p}`),a.openCreatedFile&&await this.app.workspace.getLeaf(!1).openFile(m);return}await this.app.vault.modify(m,l),new g.Notice(`Updated: ${u.title}`)}else await this.app.vault.create(p,l),new g.Notice(`Created: ${u.title}`);if(a.openCreatedFile){let h=this.app.vault.getAbstractFileByPath(p);h&&h instanceof g.TFile&&await this.app.workspace.getLeaf(!1).openFile(h)}}async createAuthorFromAudible(r,s,t){try{new g.Notice("Scraping author...");let e=await he(r,s,this.settings,t),n=this.settings.authorTemplatePath,o=await $(this.app,n),a=O(o,e),c=S(s.authorsFolder),d=`${e.author}.md`,u=`${c}/${d}`;this.app.vault.getAbstractFileByPath(c)||await this.app.vault.createFolder(c);let l=this.app.vault.getAbstractFileByPath(u);if(l&&l instanceof g.TFile){if(!this.settings.overwriteIfExists){new g.Notice("Author page already exists.");return}await this.app.vault.modify(l,a),new g.Notice(`Updated author page: ${e.author}`)}else await this.app.vault.create(u,a),new g.Notice(`Author page created: ${e.author}`);if(this.settings.openCreatedFile){let p=this.app.vault.getAbstractFileByPath(u);p instanceof g.TFile&&await this.app.workspace.getLeaf(!1).openFile(p)}}catch(e){console.error(e),new g.Notice(`Error: ${e.message}`)}}async createSeriesFromAudible(r,s,t){try{new g.Notice("Scraping series...");let e=await pe(r,this.settings,s.name,t),n=this.settings.seriesTemplatePath,o=await $(this.app,n),a=O(o,e),c=S(s.seriesFolder),d=`${Y(e.series)}.md`,u=`${c}/${d}`;this.app.vault.getAbstractFileByPath(c)||await this.app.vault.createFolder(c);let l=this.app.vault.getAbstractFileByPath(u);if(l&&l instanceof g.TFile){if(!this.settings.overwriteIfExists){new g.Notice("Series page already exists.");return}await this.app.vault.modify(l,a),new g.Notice(`Updated series page: ${e.series}`)}else await this.app.vault.create(u,a),new g.Notice(`Series page created: ${e.series}`);if(this.settings.openCreatedFile){let p=this.app.vault.getAbstractFileByPath(u);p instanceof g.TFile&&await this.app.workspace.getLeaf(!1).openFile(p)}}catch(e){console.error(e),new g.Notice(`Error: ${e.message}`)}}};
