"use strict";var x=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var M=(n,e)=>{for(var r in e)x(n,r,{get:e[r],enumerable:!0})},O=(n,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of q(e))!I.call(n,t)&&t!==r&&x(n,t,{get:()=>e[t],enumerable:!(s=B(e,t))||s.enumerable});return n};var j=n=>O(x({},"__esModule",{value:!0}),n);var ee={};M(ee,{default:()=>k});module.exports=j(ee);var g=require("obsidian");var p=require("obsidian"),F={bookTemplatePath:"Templates/BookTemplate.md",authorTemplatePath:"Templates/AuthorTemplate.md",seriesTemplatePath:"Templates/SeriesTemplate.md",archiveTemplatePath:"Templates/ArchiveTemplate.md",libraries:[{id:"default",name:"Main Library",booksRoot:"Books",authorsFolder:"Books/Authors",seriesFolder:"Books/Series",archivePath:"Books/Archive/!Archive.md"}],activeLibraryId:"default",defaultCategory:"Fiction",defaultStatus:"",defaultAcquired:"Owned",defaultSource:"Audible",defaultRatingNumber:3,ratingStyle:"classic",allowHalfStars:!0,createSeriesPages:!1,openCreatedFile:!0,overwriteIfExists:!1,tagRulesJson:JSON.stringify({baseTags:["Book","Audible"],categoryTags:{"Adult Fantasy":["Adult","Fantasy","Erotic"]}},null,2)};function w(n){return(n||"").replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"").trim()}function U(n){try{let e=JSON.parse(n),r=Array.isArray(e?.baseTags)?e.baseTags.map(String):[],s=e?.categoryTags&&typeof e.categoryTags=="object"?e.categoryTags:{},t={};for(let a of Object.keys(s)){let o=s[a];Array.isArray(o)&&(t[a]=o.map(String))}return{rules:{baseTags:r,categoryTags:t},error:""}}catch(e){return{rules:{baseTags:[],categoryTags:{}},error:e?.message||"Invalid JSON"}}}var A=class extends p.PluginSettingTab{constructor(e,r){super(e,r),this.plugin=r}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Audible Library Creator"});let r=[{key:"paths",label:"Paths & Templates"},{key:"defaults",label:"Defaults"},{key:"features",label:"Features"},{key:"tags",label:"Tags & Category Rules"},{key:"advanced",label:"Advanced / Importers"}],s="paths",t=()=>{e.findAll("div.alc-section").forEach(o=>o.remove());let a=e.createDiv({cls:"alc-section"});s==="paths"&&this.renderPaths(a),s==="defaults"&&this.renderDefaults(a),s==="features"&&this.renderFeatures(a),s==="tags"&&this.renderTags(a),s==="advanced"&&this.renderAdvanced(a)};new p.Setting(e).setName("Settings section").setDesc("Choose which settings group to view.").addDropdown(a=>{for(let o of r)a.addOption(o.key,o.label);a.setValue(s),a.onChange(o=>{s=o,t()})}),t()}renderPaths(e){e.createEl("h3",{text:"Templates"});let r=this.plugin.settings,s=(t,a,o)=>{new p.Setting(e).setName(t).setDesc(a).addText(i=>{i.setPlaceholder("Templates/MyTemplate.md"),i.setValue(String(r[o]||"")),i.onChange(async l=>{this.plugin.settings[o]=w(l),await this.plugin.saveSettings()})})};s("Book template path","Template for book notes.","bookTemplatePath"),s("Author template path","Template for author notes (optional).","authorTemplatePath"),s("Series template path","Template for series notes (optional).","seriesTemplatePath"),s("Archive template path","Template for archive notes (optional).","archiveTemplatePath"),e.createEl("h3",{text:"Libraries"}),e.createEl("p",{text:"Configure separate paths for different categories/genres. Each library has its own folders for books, authors, and series, and its own archive file."}),r.libraries.forEach((t,a)=>{let o=e.createDiv({cls:"alc-library-item"});o.style.border="1px solid var(--background-modifier-border)",o.style.padding="10px",o.style.marginBottom="10px",o.style.borderRadius="8px",new p.Setting(o).setName(`Library: ${t.name}`).addExtraButton(i=>{i.setIcon("trash").setTooltip("Delete this library").onClick(async()=>{if(r.libraries.length<=1){new Notice("You must have at least one library.");return}r.libraries.splice(a,1),r.activeLibraryId===t.id&&(r.activeLibraryId=r.libraries[0].id),await this.plugin.saveSettings(),this.display()})}),new p.Setting(o).setName("Library name").addText(i=>{i.setValue(t.name),i.onChange(async l=>{t.name=l.trim(),await this.plugin.saveSettings()})}),new p.Setting(o).setName("Books root").setDesc("Where book notes are created.").addText(i=>{i.setValue(t.booksRoot),i.onChange(async l=>{t.booksRoot=w(l),await this.plugin.saveSettings()})}),new p.Setting(o).setName("Authors folder").addText(i=>{i.setValue(t.authorsFolder),i.onChange(async l=>{t.authorsFolder=w(l),await this.plugin.saveSettings()})}),new p.Setting(o).setName("Series folder").addText(i=>{i.setValue(t.seriesFolder),i.onChange(async l=>{t.seriesFolder=w(l),await this.plugin.saveSettings()})}),new p.Setting(o).setName("Archive path").setDesc("Path to the archive .md file.").addText(i=>{i.setValue(t.archivePath),i.onChange(async l=>{t.archivePath=w(l),await this.plugin.saveSettings()})})}),new p.Setting(e).addButton(t=>{t.setButtonText("Add Library").setCta().onClick(async()=>{let a="lib-"+Date.now();r.libraries.push({id:a,name:"New Library",booksRoot:"Books/New",authorsFolder:"Books/New/Authors",seriesFolder:"Books/New/Series",archivePath:"Books/New/!Archive.md"}),await this.plugin.saveSettings(),this.display()})})}renderDefaults(e){e.createEl("h3",{text:"Defaults"});let r=this.plugin.settings;new p.Setting(e).setName("Default category").setDesc("Used when category is not provided in the modal.").addText(s=>{s.setValue(r.defaultCategory||""),s.onChange(async t=>{this.plugin.settings.defaultCategory=t.trim(),await this.plugin.saveSettings()})}),new p.Setting(e).setName("Default status").setDesc("Blank by default is recommended for bulk importing.").addText(s=>{s.setValue(r.defaultStatus||""),s.onChange(async t=>{this.plugin.settings.defaultStatus=t.trim(),await this.plugin.saveSettings()})}),new p.Setting(e).setName("Default acquired").setDesc("Example: Owned, Wish Listed.").addText(s=>{s.setValue(r.defaultAcquired||""),s.onChange(async t=>{this.plugin.settings.defaultAcquired=t.trim(),await this.plugin.saveSettings()})}),new p.Setting(e).setName("Default source").setDesc("Example: Audible.").addText(s=>{s.setValue(r.defaultSource||""),s.onChange(async t=>{this.plugin.settings.defaultSource=t.trim(),await this.plugin.saveSettings()})}),e.createEl("h4",{text:"Rating"}),new p.Setting(e).setName("Default rating number").setDesc("Example: 3 or 3.5").addText(s=>{s.setValue(String(r.defaultRatingNumber)),s.onChange(async t=>{let a=Number(t);Number.isFinite(a)&&(this.plugin.settings.defaultRatingNumber=a,await this.plugin.saveSettings())})}),new p.Setting(e).setName("Rating style").setDesc("Emoji stars or classic symbols.").addDropdown(s=>{s.addOption("emoji","Emoji (\u2B50)"),s.addOption("classic","Classic (\u2605)"),s.setValue(r.ratingStyle),s.onChange(async t=>{this.plugin.settings.ratingStyle=t,await this.plugin.saveSettings()})}),new p.Setting(e).setName("Allow half stars").setDesc("If enabled, 3.5 can render as 3 and a half.").addToggle(s=>{s.setValue(r.allowHalfStars),s.onChange(async t=>{this.plugin.settings.allowHalfStars=t,await this.plugin.saveSettings()})})}renderFeatures(e){e.createEl("h3",{text:"Features"});let r=this.plugin.settings;new p.Setting(e).setName("Create series pages").setDesc("Optional, not implemented yet (placeholder).").addToggle(s=>{s.setValue(r.createSeriesPages),s.onChange(async t=>{this.plugin.settings.createSeriesPages=t,await this.plugin.saveSettings()})}),e.createEl("h4",{text:"Creation behavior"}),new p.Setting(e).setName("Open created file automatically").addToggle(s=>{s.setValue(r.openCreatedFile),s.onChange(async t=>{this.plugin.settings.openCreatedFile=t,await this.plugin.saveSettings()})}),new p.Setting(e).setName("Overwrite if exists").setDesc("If a file already exists, replace it.").addToggle(s=>{s.setValue(r.overwriteIfExists),s.onChange(async t=>{this.plugin.settings.overwriteIfExists=t,await this.plugin.saveSettings()})})}renderTags(e){e.createEl("h3",{text:"Tags & Category Rules"});let r=this.plugin.settings,s=U(r.tagRulesJson);s.error&&e.createEl("p",{text:`JSON error: ${s.error}`}),new p.Setting(e).setName("Tag rules (JSON)").setDesc("Controls base tags and per-category tags.").addTextArea(t=>{t.setValue(r.tagRulesJson),t.inputEl.rows=14,t.onChange(async a=>{this.plugin.settings.tagRulesJson=a,await this.plugin.saveSettings()})})}renderAdvanced(e){e.createEl("h3",{text:"Advanced / Importers"}),e.createEl("p",{text:"Coming soon: batch import from library and wishlist pages."})}};function f(n){let e=(n??"").trim();if(!e)return"";try{let r=new URL(e);return r.search="",r.hash="",r.toString()}catch{return e.split("?")[0].split("#")[0]}}function m(n){return(n??"").replace(/\u00A0|\u202F|\u2009/g," ").replace(/\s+/g," ").trim()}function V(n){let e=m(n);return e=e.split(":").join(" - "),e=e.split("&").join(" and "),e=e.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),e=m(e),e=e.replace(/[. ]+$/g,"").trim(),e.length>180&&(e=e.slice(0,180).trim()),e}function N(n){let e=new Set,r=[];for(let s of n){let t=(s??"").trim();t&&(e.has(t)||(e.add(t),r.push(t)))}return r}function v(n){let e=m(n).replace(/&amp;/g,"&");if(!e)return[];let s=e.replace(/\s*(,|\||\/|•|·)\s*/g,",").replace(/\s*&\s*/g," & ").split(",").map(a=>a.trim()).filter(Boolean),t=[];for(let a of s){let o=a.includes(" & ")?a.split(" & ").map(i=>i.trim()).filter(Boolean):[a];for(let i of o){let l=i.replace(/[^\w\s-]/g,"").trim();if(!l)continue;let d=l.split(/\s+/).map(u=>u.charAt(0).toUpperCase()+u.slice(1)).join("");d&&t.push(d)}}return N(t)}function E(n){let e=(n??"").trim();if(!e)return"";let r=e.startsWith("/")?`https://www.audible.com${e}`:e;return f(r)}function H(n){return new DOMParser().parseFromString(n,"text/html")}function $(n){let e=[],r=Array.from(n.querySelectorAll('script[type="application/ld+json"]'));for(let s of r){let t=(s.textContent??"").trim();if(t)try{let a=JSON.parse(t);if(Array.isArray(a))for(let o of a)o&&typeof o=="object"&&e.push(o);else a&&typeof a=="object"&&e.push(a)}catch{}}return e}function J(n){for(let e of n){let r=e?.["@type"];if((Array.isArray(r)?r.map(t=>String(t).toLowerCase()):[String(r??"").toLowerCase()]).some(t=>["book","audiobook","product","creativework"].includes(t)))return e}return n.length?n[0]:null}function _(n,e,r){let s=typeof r?.name=="string"?m(r.name):"",t=typeof r?.url=="string"?f(r.url):"";if(s)return{title:s,url:t||f(e)};let a=n.querySelector('meta[property="og:title"]')?.content??n.querySelector('meta[name="og:title"]')?.content??"";return a?{title:m(a),url:f(e)}:{title:"Unknown Title",url:f(e)}}function W(n,e){let r=e?.image;if(typeof r=="string"&&r.startsWith("http"))return f(r);if(Array.isArray(r)&&typeof r[0]=="string")return f(r[0]);let s=n.querySelector('meta[property="og:image"]')?.content??n.querySelector('meta[name="og:image"]')?.content??"";return s?f(s):""}function z(n,e){let r=typeof e?.description=="string"?m(e.description):"";if(r)return r;let s=n.querySelector('meta[property="og:description"]')?.content??n.querySelector('meta[name="og:description"]')?.content??"";return s?m(s):""}function L(n){let e=new Set,r=[];for(let s of n){let t=m(s.name);if(!t)continue;let a=t.toLowerCase();e.has(a)||(e.add(a),r.push({name:t,url:f(s.url??"")}))}return r}function G(n,e){let r=[],s=(c,y)=>{let b=m(c);b&&r.push({name:b,url:f(y??"")})},t=e?.author;if(Array.isArray(t))for(let c of t)typeof c=="string"?s(c):c&&typeof c=="object"&&s(c.name??"",c.url??"");else t&&typeof t=="object"?s(t.name??"",t.url??""):typeof t=="string"&&s(t);let a=L(r);if(!(a.length===0||a.some(c=>!c.url)))return a;let i=[],l=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]'];for(let c of l)i.push(...Array.from(n.querySelectorAll(c)));let d=Array.from(n.querySelectorAll("div,span,section"));for(let c of d){let y=c.textContent??"";/(\bBy\b|\bWritten by\b|\bAuthor\b)/i.test(y)&&c.querySelector('a[href*="/author/"]')&&i.push(c)}let u=new Map;for(let c of i){let y=Array.from(c.querySelectorAll('a[href*="/author/"]'));for(let b of y){let S=m(b.textContent??"");S&&u.set(S.toLowerCase(),E(b.getAttribute("href")??""))}}if(a.length)return a=a.map(c=>{if(c.url)return c;let y=u.get(c.name.toLowerCase())??"";return{name:c.name,url:f(y)}}),L(a);let h=[];for(let[c,y]of u.entries()){let b=c.replace(/\b\w/g,S=>S.toUpperCase());h.push({name:b,url:f(y)})}return L(h)}function K(n){let e=o=>{let l=m(o).match(/\bBook\s+(\d+)\b/i);return l?l[1]:""},r=n.querySelector('div[data-testid="line"][data-event-id="series"]')||n.querySelector('div[data-testid="line"][key="series"]');if(!r){let o=Array.from(n.querySelectorAll('div[data-testid="line"]'));for(let i of o){let l=i.querySelector(".label");if(m(l?.textContent??"").toLowerCase()==="series"){r=i;break}}}let s="",t="",a="";if(r){let o=r.querySelector('a.link[href*="/series/"]');o&&(s=m(o.textContent??""),t=E(o.getAttribute("href")??"")),a=e(r.textContent??"")}if(!t){let o=n.querySelector('a[href*="/series/"]');if(o){s=m(o.textContent??""),t=E(o.getAttribute("href")??"");let i=o.parentElement;for(let l=0;l<4&&i&&!a;l++)a=e(i.textContent??""),i=i.parentElement}}if(!(!s||!t))return{name:s,url:f(t),book:a??""}}function Y(n,e){let r=[],s=Array.from(n.querySelectorAll("adbl-chip-group.product-topictag-impression adbl-chip"));for(let i of s){let l=m(i.textContent??"");l&&r.push(...v(l))}let t=n.querySelector('div[data-testid="line"][key="categories"]');if(t){let i=Array.from(t.querySelectorAll("a.link[href]"));for(let l of i){let d=m(l.textContent??"");d&&r.push(...v(d))}}let a=e?.genre;if(typeof a=="string")r.push(...v(a));else if(Array.isArray(a))for(let i of a)typeof i=="string"&&r.push(...v(i));let o=new Set(["audible","audiobooks","audiobook"]);return r=r.filter(i=>i&&!o.has(i.toLowerCase())),N(r)}async function Q(n,e){let r=(e??"").trim();if(!r)throw new Error("Template path is empty.");let s=r.replace(/\\/g,"/").replace(/^\/+/,""),t=n.vault.getAbstractFileByPath(s);if(!t||!(t instanceof g.TFile))throw new Error(`Template not found: ${s}`);return await n.vault.read(t)}function X(n,e){let r=e.authors.map(h=>h.name).filter(Boolean).join(", "),s=e.authors.length?e.authors.map(h=>h.url?`[${h.name}](${f(h.url)})`:h.name).join(`,  
`):"_Unknown_",t=e.series?.name??"",a=e.series?e.series.url?`[${e.series.name}](${f(e.series.url)})`:e.series.name:"",o=e.series?.book??"",i=e.tags.map(h=>`#${h}`).join(" "),l="["+e.tags.map(h=>JSON.stringify(h)).join(",")+"]",d=n,u=(h,c)=>{d=d.split(h).join(c)};return u("{{type}}",e.type??""),u("{{status}}",e.status??""),u("{{category}}",e.category??""),u("{{acquired}}",e.acquired??""),u("{{source}}",e.source??""),u("{{title}}",e.title??""),u("{{url}}",f(e.url??"")),u("{{cover_url}}",f(e.coverUrl??"")),u("{{authors_md}}",s),u("{{authors_plain}}",r),u("{{series_md}}",a),u("{{series_plain}}",t),u("{{book_md}}",o),u("{{description}}",(e.description??"").trim()),u("{{rating}}",e.rating??""),u("{{tags}}",i),u("{{tags_yaml}}",l),d=d.replace(/\n{4,}/g,`


`),d.trim()+`
`}async function Z(n,e,r,s,t){let o=(await(0,g.requestUrl)({url:n,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,i=H(o),l=$(i),d=J(l),{title:u,url:h}=_(i,n,d),c=V(u),y=W(i,d),b=z(i,d),S=G(i,d),R=K(i),T=[],D=JSON.parse(r.tagRulesJson);T.push(...D.baseTags||[]),T.push(...Y(i,d));let C=D.categoryTags?.[e.name];return C&&Array.isArray(C)&&T.push(...C),T=N(T),{title:c,url:f(h),coverUrl:y,authors:S,series:R,description:b,category:e.name,status:s??r.defaultStatus,acquired:r.defaultAcquired,source:r.defaultSource,rating:t??String(r.defaultRatingNumber),tags:T,type:"book"}}var P=class extends g.Modal{constructor(r,s){super(r);this.url="";this.libraryId="";this.status="";this.rating="";this.plugin=s,this.libraryId=s.settings.activeLibraryId,this.status=s.settings.defaultStatus,this.rating=String(s.settings.defaultRatingNumber)}async onOpen(){let{contentEl:r}=this;r.empty(),r.createEl("h2",{text:"Create Book from Audible"}),new g.Setting(r).setName("Audible URL").setDesc("Paste the Audible book page URL (https://www.audible.com/pd/...)").addText(s=>{s.setPlaceholder("https://www.audible.com/pd/...").onChange(t=>this.url=t.trim()),s.inputEl.style.width="100%"}),new g.Setting(r).setName("Library").setDesc("Select the target library for this book.").addDropdown(s=>{this.plugin.settings.libraries.forEach(t=>{s.addOption(t.id,t.name)}),s.setValue(this.libraryId),s.onChange(t=>this.libraryId=t)}),new g.Setting(r).setName("Status").addText(s=>{s.setValue(this.status).onChange(t=>this.status=t.trim()),s.inputEl.style.width="100%"}),new g.Setting(r).setName("Rating").setDesc("Numeric rating (e.g. 3 or 4.5)").addText(s=>{s.setValue(this.rating).onChange(t=>this.rating=t.trim()),s.inputEl.style.width="100%"}),new g.Setting(r).addButton(s=>{s.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new g.Notice("Please enter an Audible URL.");return}let t=this.plugin.settings.libraries.find(a=>a.id===this.libraryId);if(!t){new g.Notice("Selected library not found.");return}this.plugin.settings.activeLibraryId!==this.libraryId&&(this.plugin.settings.activeLibraryId=this.libraryId,await this.plugin.saveSettings()),await this.plugin.createBookFromAudible(this.url,t,this.status,this.rating),this.close()}catch(t){console.error(t),new g.Notice(`Failed: ${t?.message??String(t)}`)}})}),new g.Setting(r).addButton(s=>{s.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},k=class extends g.Plugin{async onload(){console.log(`Audible Library Creator v${this.manifest.version} loading...`),await this.loadSettings(),this.addCommand({id:"create-book-from-audible",name:"Create Book from Audible",callback:()=>new P(this.app,this).open()}),this.addSettingTab(new A(this.app,this))}async loadSettings(){this.settings=Object.assign({},F,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createBookFromAudible(e,r,s,t){let a=this.settings,o=w(r.booksRoot);this.app.vault.getAbstractFileByPath(o)||await this.app.vault.createFolder(o),new g.Notice("Fetching Audible page\u2026");let l=await Z(e,r,a,s,t),d=await Q(this.app,a.bookTemplatePath),u=X(d,l),h=w(`${o}/${l.title}.md`),c=this.app.vault.getAbstractFileByPath(h);if(c&&c instanceof g.TFile){if(!a.overwriteIfExists){new g.Notice(`File exists: ${h}`),a.openCreatedFile&&await this.app.workspace.getLeaf(!1).openFile(c);return}await this.app.vault.modify(c,u),new g.Notice(`Updated: ${l.title}`)}else await this.app.vault.create(h,u),new g.Notice(`Created: ${l.title}`);if(a.openCreatedFile){let y=this.app.vault.getAbstractFileByPath(h);y&&y instanceof g.TFile&&await this.app.workspace.getLeaf(!1).openFile(y)}}};
