"use strict";var M=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var Z=(l,r)=>{for(var s in r)M(l,s,{get:r[s],enumerable:!0})},ee=(l,r,s,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of Q(r))!X.call(l,e)&&e!==s&&M(l,e,{get:()=>r[e],enumerable:!(t=K(r,e))||t.enumerable});return l};var te=l=>ee(M({},"__esModule",{value:!0}),l);var fe={};Z(fe,{default:()=>O});module.exports=te(fe);var c=require("obsidian");var y=require("obsidian"),z={bookTemplatePath:"Templates/BookTemplate.md",authorTemplatePath:"Templates/AuthorTemplate.md",seriesTemplatePath:"Templates/SeriesTemplate.md",archiveTemplatePath:"Templates/ArchiveTemplate.md",libraries:[{id:"default",name:"Main Library",booksRoot:"Books",authorsFolder:"Books/Authors",seriesFolder:"Books/Series",archivePath:"Books/Archive/!Archive.md"}],activeLibraryId:"default",defaultCategory:"Fiction",defaultStatus:"",defaultAcquired:"Owned",defaultSource:"Audible",defaultRatingNumber:3,ratingStyle:"classic",allowHalfStars:!0,showBookRibbonIcon:!0,showSeriesRibbonIcon:!0,showAuthorRibbonIcon:!1,openCreatedFile:!0,overwriteIfExists:!1,tagRulesJson:JSON.stringify({baseTags:["Book","Audible"],categoryTags:{"Adult Fantasy":["Adult","Fantasy","Erotic"]}},null,2)};function v(l){return(l||"").replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"").trim()}function se(l){try{let r=JSON.parse(l),s=Array.isArray(r?.baseTags)?r.baseTags.map(String):[],t=r?.categoryTags&&typeof r.categoryTags=="object"?r.categoryTags:{},e={};for(let a of Object.keys(t)){let i=t[a];Array.isArray(i)&&(e[a]=i.map(String))}return{rules:{baseTags:s,categoryTags:e},error:""}}catch(r){return{rules:{baseTags:[],categoryTags:{}},error:r?.message||"Invalid JSON"}}}var R=class extends y.PluginSettingTab{constructor(r,s){super(r,s),this.plugin=s}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:"Audible Library Creator"});let s=[{key:"paths",label:"Paths & Templates"},{key:"defaults",label:"Defaults"},{key:"features",label:"Features"},{key:"tags",label:"Tags & Category Rules"},{key:"advanced",label:"Advanced / Importers"}],t="paths",e=()=>{r.findAll("div.alc-section").forEach(i=>i.remove());let a=r.createDiv({cls:"alc-section"});t==="paths"&&this.renderPaths(a),t==="defaults"&&this.renderDefaults(a),t==="features"&&this.renderFeatures(a),t==="tags"&&this.renderTags(a),t==="advanced"&&this.renderAdvanced(a)};new y.Setting(r).setName("Settings section").setDesc("Choose which settings group to view.").addDropdown(a=>{for(let i of s)a.addOption(i.key,i.label);a.setValue(t),a.onChange(i=>{t=i,e()})}),e()}renderPaths(r){r.createEl("h3",{text:"Templates"});let s=this.plugin.settings,t=(e,a,i)=>{new y.Setting(r).setName(e).setDesc(a).addText(n=>{n.setPlaceholder("Templates/MyTemplate.md"),n.setValue(String(s[i]||"")),n.onChange(async u=>{this.plugin.settings[i]=v(u),await this.plugin.saveSettings()})})};t("Book template path","Template for book notes.","bookTemplatePath"),t("Author template path","Template for Author Notes (Leave blank to disable Author Pages).","authorTemplatePath"),t("Series template path","Template for Series Notes (Leave blank to disable Series Pages).","seriesTemplatePath"),t("Archive template path","Template for archive notes (optional).","archiveTemplatePath"),r.createEl("h3",{text:"Libraries"}),r.createEl("p",{text:"Configure separate paths for different categories/genres. Each library has its own folders for books, authors, and series, and its own archive file."}),s.libraries.forEach((e,a)=>{let i=r.createDiv({cls:"alc-library-item"});i.style.border="1px solid var(--background-modifier-border)",i.style.padding="10px",i.style.marginBottom="10px",i.style.borderRadius="8px",new y.Setting(i).setName(`Library: ${e.name}`).addExtraButton(n=>{n.setIcon("trash").setTooltip("Delete this library").onClick(async()=>{if(s.libraries.length<=1){new Notice("You must have at least one library.");return}s.libraries.splice(a,1),s.activeLibraryId===e.id&&(s.activeLibraryId=s.libraries[0].id),await this.plugin.saveSettings(),this.display()})}),new y.Setting(i).setName("Library name").addText(n=>{n.setValue(e.name),n.onChange(async u=>{e.name=u.trim(),await this.plugin.saveSettings()})}),new y.Setting(i).setName("Books root").setDesc("Where book notes are created.").addText(n=>{n.setValue(e.booksRoot),n.onChange(async u=>{e.booksRoot=v(u),await this.plugin.saveSettings()})}),new y.Setting(i).setName("Authors folder").setDesc("Leave blank to not use Author Pages for this library.").addText(n=>{n.setValue(e.authorsFolder),n.onChange(async u=>{e.authorsFolder=v(u),await this.plugin.saveSettings()})}),new y.Setting(i).setName("Series folder").setDesc("Leave blank to not use Series Pages for this library.").addText(n=>{n.setValue(e.seriesFolder),n.onChange(async u=>{e.seriesFolder=v(u),await this.plugin.saveSettings()})}),new y.Setting(i).setName("Archive path").setDesc("Path to the archive .md file.").addText(n=>{n.setValue(e.archivePath),n.onChange(async u=>{e.archivePath=v(u),await this.plugin.saveSettings()})})}),new y.Setting(r).addButton(e=>{e.setButtonText("Add Library").setCta().onClick(async()=>{let a="lib-"+Date.now();s.libraries.push({id:a,name:"New Library",booksRoot:"Books/New",authorsFolder:"Books/New/Authors",seriesFolder:"Books/New/Series",archivePath:"Books/New/!Archive.md"}),await this.plugin.saveSettings(),this.display()})})}renderDefaults(r){r.createEl("h3",{text:"Defaults"});let s=this.plugin.settings;new y.Setting(r).setName("Default category").setDesc("Used when category is not provided in the modal.").addText(t=>{t.setValue(s.defaultCategory||""),t.onChange(async e=>{this.plugin.settings.defaultCategory=e.trim(),await this.plugin.saveSettings()})}),new y.Setting(r).setName("Default status").setDesc("Blank by default is recommended for bulk importing.").addText(t=>{t.setValue(s.defaultStatus||""),t.onChange(async e=>{this.plugin.settings.defaultStatus=e.trim(),await this.plugin.saveSettings()})}),new y.Setting(r).setName("Default acquired").setDesc("Example: Owned, Wish Listed.").addText(t=>{t.setValue(s.defaultAcquired||""),t.onChange(async e=>{this.plugin.settings.defaultAcquired=e.trim(),await this.plugin.saveSettings()})}),new y.Setting(r).setName("Default source").setDesc("Example: Audible.").addText(t=>{t.setValue(s.defaultSource||""),t.onChange(async e=>{this.plugin.settings.defaultSource=e.trim(),await this.plugin.saveSettings()})}),r.createEl("h4",{text:"Rating"}),new y.Setting(r).setName("Default rating number").setDesc("Example: 3 or 3.5").addText(t=>{t.setValue(String(s.defaultRatingNumber)),t.onChange(async e=>{let a=Number(e);Number.isFinite(a)&&(this.plugin.settings.defaultRatingNumber=a,await this.plugin.saveSettings())})}),new y.Setting(r).setName("Rating style").setDesc("Emoji stars or classic symbols.").addDropdown(t=>{t.addOption("emoji","Emoji (\u2B50)"),t.addOption("classic","Classic (\u2605)"),t.setValue(s.ratingStyle),t.onChange(async e=>{this.plugin.settings.ratingStyle=e,await this.plugin.saveSettings()})}),new y.Setting(r).setName("Allow half stars").setDesc("If enabled, 3.5 can render as 3 and a half.").addToggle(t=>{t.setValue(s.allowHalfStars),t.onChange(async e=>{this.plugin.settings.allowHalfStars=e,await this.plugin.saveSettings()})})}renderFeatures(r){r.createEl("h3",{text:"Features"});let s=this.plugin.settings;r.createEl("h4",{text:"Creation behavior"}),new y.Setting(r).setName("Open created file automatically").addToggle(e=>{e.setValue(s.openCreatedFile),e.onChange(async a=>{this.plugin.settings.openCreatedFile=a,await this.plugin.saveSettings()})}),new y.Setting(r).setName("Overwrite if exists").setDesc("If a file already exists, replace it.").addToggle(e=>{e.setValue(s.overwriteIfExists),e.onChange(async a=>{this.plugin.settings.overwriteIfExists=a,await this.plugin.saveSettings()})}),r.createEl("h4",{text:"Ribbon icons"});let t=(e,a)=>{new y.Setting(r).setName(`Show "${e}" ribbon icon`).addToggle(i=>{i.setValue(s[a]),i.onChange(async n=>{this.plugin.settings[a]=n,await this.plugin.saveSettings(),this.plugin.refreshRibbonIcons()})})};t("Add Audible Book","showBookRibbonIcon"),t("Add Audible Series","showSeriesRibbonIcon"),t("Add Audible Author","showAuthorRibbonIcon")}renderTags(r){r.createEl("h3",{text:"Tags & Category Rules"});let s=this.plugin.settings,t=se(s.tagRulesJson);t.error&&r.createEl("p",{text:`JSON error: ${t.error}`}),new y.Setting(r).setName("Tag rules (JSON)").setDesc("Controls base tags and per-category tags.").addTextArea(e=>{e.setValue(s.tagRulesJson),e.inputEl.rows=14,e.onChange(async a=>{this.plugin.settings.tagRulesJson=a,await this.plugin.saveSettings()})})}renderAdvanced(r){r.createEl("h3",{text:"Advanced / Importers"}),r.createEl("p",{text:"Coming soon: batch import from library and wishlist pages."})}};function w(l){let r=(l??"").trim();if(!r)return"";try{let s=new URL(r,"https://www.audible.com");return s.pathname.includes("/search")||(s.search=""),s.hash="",s.toString()}catch{return r.includes("/search")?r.split("#")[0]:r.split("?")[0].split("#")[0]}}function p(l){return(l??"").replace(/\u00A0|\u202F|\u2009/g," ").replace(/\s+/g," ").trim()}function Y(l){let r=p(l);return r=r.split(":").join(" - "),r=r.split("&").join(" and "),r=r.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),r=p(r),r=r.replace(/[. ]+$/g,"").trim(),r.length>180&&(r=r.slice(0,180).trim()),r}function U(l){let r=new Set,s=[];for(let t of l){let e=(t??"").trim();e&&(r.has(e)||(r.add(e),s.push(e)))}return s}function N(l){let r=p(l).replace(/&amp;/g,"&");if(!r)return[];let t=r.replace(/\s*(,|\||\/|•|·)\s*/g,",").replace(/\s*&\s*/g," & ").split(",").map(a=>a.trim()).filter(Boolean),e=[];for(let a of t){let i=a.includes(" & ")?a.split(" & ").map(n=>n.trim()).filter(Boolean):[a];for(let n of i){let u=n.replace(/[^\w\s-]/g,"").trim();if(!u)continue;let g=u.split(/\s+/).map(h=>h.charAt(0).toUpperCase()+h.slice(1)).join("");g&&e.push(g)}}return U(e)}function C(l){let r=(l??"").trim();if(!r)return"";let s=r.startsWith("/")?`https://www.audible.com${r}`:r;return w(s)}function _(l){return new DOMParser().parseFromString(l,"text/html")}function H(l){let r=[],s=Array.from(l.querySelectorAll('script[type="application/ld+json"]'));for(let t of s){let e=(t.textContent??"").trim();if(e)try{let a=JSON.parse(e);if(Array.isArray(a))for(let i of a)i&&typeof i=="object"&&r.push(i);else a&&typeof a=="object"&&r.push(a)}catch{}}return r}function J(l){for(let r of l){let s=r?.["@type"];if((Array.isArray(s)?s.map(e=>String(e).toLowerCase()):[String(s??"").toLowerCase()]).some(e=>["book","audiobook","product","creativework"].includes(e)))return r}return l.length?l[0]:null}function T(l,r){let s=Array.from(l.querySelectorAll(r)),t=l.querySelectorAll("template");for(let e=0;e<t.length;e++){let a=t[e];a.content&&s.push(...T(a.content,r))}return s}function re(l){let r=l.querySelector('adbl-product-metadata script[type="application/json"]');if(!r)return null;try{return JSON.parse(r.textContent??"{}")}catch{return null}}function ne(l,r,s){let t=typeof s?.name=="string"?p(s.name):"",e=typeof s?.url=="string"?w(s.url):"";if(t)return{title:t,url:e||w(r)};let a=l.querySelector('meta[property="og:title"]')?.content??l.querySelector('meta[name="og:title"]')?.content??"";return a?{title:p(a),url:w(r)}:{title:"Unknown Title",url:w(r)}}function ie(l,r){let s=r?.image;if(typeof s=="string"&&s.startsWith("http"))return w(s);if(Array.isArray(s)&&typeof s[0]=="string")return w(s[0]);let t=l.querySelector('meta[property="og:image"]')?.content??l.querySelector('meta[name="og:image"]')?.content??"";return t?w(t):""}function W(l,r){let s=typeof r?.description=="string"?p(r.description):"";if(s)return s;let t=l.querySelector('meta[property="og:description"]')?.content??l.querySelector('meta[name="og:description"]')?.content??"";return t?p(t):""}function D(l){let r=new Set,s=[];for(let t of l){let e=p(t.name);if(!e)continue;let a=e.toLowerCase();r.has(a)||(r.add(a),s.push({name:e,url:w(t.url??"")}))}return s}function ae(l,r){let s=[],t=(o,m)=>{let f=p(o);f&&s.push({name:f,url:w(m??"")})},e=r?.author;if(Array.isArray(e))for(let o of e)typeof o=="string"?t(o):o&&typeof o=="object"&&t(o.name??"",o.url??"");else e&&typeof e=="object"?t(e.name??"",e.url??""):typeof e=="string"&&t(e);let a=D(s);if(!(a.length===0||a.some(o=>!o.url)))return a;let n=[],u=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]'];for(let o of u)n.push(...T(l,o));let g=T(l,"div,span,section");for(let o of g){let m=o.textContent??"";/(\bBy\b|\bWritten by\b|\bAuthor\b)/i.test(m)&&o.querySelector('a[href*="/author/"]')&&n.push(o)}let h=new Map;for(let o of n){let m=Array.from(o.querySelectorAll('a[href*="/author/"]'));for(let f of m){let b=p(f.textContent??"");b&&h.set(b.toLowerCase(),C(f.getAttribute("href")??""))}}if(a.length)return a=a.map(o=>{if(o.url)return o;let m=h.get(o.name.toLowerCase())??"";return{name:o.name,url:C(m)}}),D(a);let A=[];for(let[o,m]of h.entries()){let f=o.replace(/\b\w/g,b=>b.toUpperCase());A.push({name:f,url:w(m)})}return D(A)}function oe(l,r){let s=[],t=(o,m)=>{let f=p(o);f&&s.push({name:f,url:C(m??"")})},e=r?.readBy??r?.narrator;if(Array.isArray(e))for(let o of e)typeof o=="string"?t(o):o&&typeof o=="object"&&t(o.name??"",o.url??"");else e&&typeof e=="object"?t(e.name??"",e.url??""):typeof e=="string"&&t(e);let a=D(s);if(!(a.length===0||a.some(o=>!o.url)))return a;let n=[],u=['[data-testid*="byline"]','[class*="byLine"]','[class*="byline"]','[data-testid*="narrator"]','[data-testid="line"]'];for(let o of u)n.push(...T(l,o));let g=T(l,"div,span,section,li");for(let o of g){let m=o.textContent??"";/\bNarrated by\b/i.test(m)&&o.querySelector('a[href*="/narrator/"], a[href*="Narrator"], a[href*="narrator"]')&&n.push(o)}let h=new Map;for(let o of n){let m=Array.from(o.querySelectorAll("a[href]"));for(let f of m){let b=f.getAttribute("href")??"";if(!b.toLowerCase().includes("narrator")&&!b.toLowerCase().includes("search"))continue;let d=p(f.textContent??"");d&&h.set(d.toLowerCase(),C(b))}}if(a.length)return a=a.map(o=>{if(o.url)return o;let m=h.get(o.name.toLowerCase())??"";return{name:o.name,url:C(m)}}),D(a);let A=[];for(let[o,m]of h.entries()){let f=o.replace(/\b\w/g,b=>b.toUpperCase());A.push({name:f,url:C(m)})}return D(A)}function le(l,r,s){if(r?.duration)return p(r.duration);if(s?.duration){let n=String(s.duration);if(n.startsWith("PT")){let u=n.match(/(\d+)H/)?.[1],g=n.match(/(\d+)M/)?.[1],h="";return u&&(h+=`${u} hrs `),g&&(h+=`${g} mins`),p(h)||n}return p(n)}let e=T(l,'[data-testid="line"]').find(n=>{let u=n.querySelector(".label")?.textContent?.toLowerCase()??"",g=n.getAttribute("data-event-id")?.toLowerCase()??"",h=n.getAttribute("key")?.toLowerCase()??"";return u.includes("length")||u.includes("runtime")||g==="duration"||g==="runtime"||h==="duration"||h==="runtime"});if(!e)return"";let a=e.querySelector(".values .text")?.textContent;if(a)return p(a);let i=e.textContent?.split(":")??[];return p(i[1]??"")}function ce(l,r,s){let t=(u,g)=>({name:p(u),url:C(g??"")}),e="",a="";if(r?.publisher&&(typeof r.publisher=="string"?e=r.publisher:(e=r.publisher.name??"",a=r.publisher.url??"")),e||(s?.publisher?.name?(e=s.publisher.name,a=s.publisher.url??""):typeof s?.publisher=="string"&&(e=s.publisher)),!e){let g=T(l,'[data-testid="line"]').find(h=>{let A=h.querySelector(".label")?.textContent?.toLowerCase()??"",o=h.getAttribute("data-event-id")?.toLowerCase()??"",m=h.getAttribute("key")?.toLowerCase()??"";return A.includes("publisher")||o==="publisher"||m==="publisher"});if(g){let h=g.querySelector("a");if(h)e=h.textContent??"",a=h.getAttribute("href")??"";else{let A=g.querySelector(".values .text")?.textContent;if(A)e=A;else{let o=g.textContent?.split(":")??[];o[1]&&(e=o[1])}}}}if(e=p(e),a=C(a),!e)return t("Unknown Publisher");if(a)return t(e,a);let i=T(l,"a[href]");for(let u of i){let g=u.getAttribute("href")??"",h=p(u.textContent??"");if(h.toLowerCase()===e.toLowerCase()||g.toLowerCase().includes("search")&&(g.toLowerCase().includes("provider")||g.toLowerCase().includes("publisher"))&&(h.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(h.toLowerCase())))return t(e,g)}let n=`https://www.audible.com/search?searchProvider=${encodeURIComponent(e)}`;return t(e,n)}function ue(l,r,s){if(r?.releaseDate)return p(r.releaseDate);if(s?.datePublished)return p(s.datePublished);let e=T(l,'[data-testid="line"]').find(n=>{let u=n.querySelector(".label")?.textContent?.toLowerCase()??"",g=n.getAttribute("data-event-id")?.toLowerCase()??"",h=n.getAttribute("key")?.toLowerCase()??"";return u.includes("release date")||g==="releasedate"||h==="releasedate"});if(!e)return"";let a=e.querySelector(".values .text")?.textContent;if(a)return p(a);let i=e.textContent?.split(":")??[];return p(i[1]??"")}function ge(l){let r=i=>{let u=p(i).match(/\bBook\s+(\d+)\b/i);return u?u[1]:""},s=l.querySelector('div[data-testid="line"][data-event-id="series"]')||l.querySelector('div[data-testid="line"][key="series"]');if(!s){let i=Array.from(l.querySelectorAll('div[data-testid="line"]'));for(let n of i){let u=n.querySelector(".label");if(p(u?.textContent??"").toLowerCase()==="series"){s=n;break}}}let t="",e="",a="";if(s){let i=s.querySelector('a.link[href*="/series/"]');i&&(t=p(i.textContent??""),e=C(i.getAttribute("href")??"")),a=r(s.textContent??"")}if(!e){let i=l.querySelector('a[href*="/series/"]');if(i){t=p(i.textContent??""),e=C(i.getAttribute("href")??"");let n=i.parentElement;for(let u=0;u<4&&n&&!a;u++)a=r(n.textContent??""),n=n.parentElement}}if(!(!t||!e))return{name:t,url:w(e),book:a??""}}function G(l,r){let s=[],t=Array.from(l.querySelectorAll("adbl-chip-group.product-topictag-impression adbl-chip, adbl-chip-group.related-tag-impression adbl-chip"));for(let n of t){let u=p(n.textContent??"");u&&s.push(...N(u))}let e=l.querySelector('div[data-testid="line"][key="categories"]');if(e){let n=Array.from(e.querySelectorAll("a.link[href]"));for(let u of n){let g=p(u.textContent??"");g&&s.push(...N(g))}}let a=r?.genre;if(typeof a=="string")s.push(...N(a));else if(Array.isArray(a))for(let n of a)typeof n=="string"&&s.push(...N(n));let i=new Set(["audible","audiobooks","audiobook"]);return s=s.filter(n=>n&&!i.has(n.toLowerCase())),U(s)}async function V(l,r){let s=(r??"").trim();if(!s)throw new Error("Template path is empty.");let t=s.replace(/\\/g,"/").replace(/^\/+/,""),e=l.vault.getAbstractFileByPath(t);if(!e||!(e instanceof c.TFile))throw new Error(`Template not found: ${t}`);return await l.vault.read(e)}function j(l,r){let s=l,t=(e,a)=>{s=s.split(e).join(a)};if("title"in r){let e=r,a=e.authors.map(d=>d.name).filter(Boolean).join(", "),i=e.authors_md_override??(e.authors.length?e.authors.map(d=>d.url?`[${d.name}](${w(d.url)})`:d.name).join(`,  
`):"_Unknown_"),n=(e.narrators??[]).map(d=>d.name).filter(Boolean).join(", "),u=(e.narrators??[]).length?(e.narrators??[]).map(d=>d.url?`[${d.name}](${w(d.url)})`:d.name).join(`,  
`):"_Unknown_",g=e.series?.name??"",h=e.series?e.series.url?`[${e.series.name}](${w(e.series.url)})`:e.series.name:"",A=e.series?.book??"",o=e.publisher?.name??"",m=e.publisher?e.publisher.url?`[${e.publisher.name}](${w(e.publisher.url)})`:e.publisher.name:"",f=e.tags.map(d=>`#${d}`).join(" "),b="["+e.tags.map(d=>JSON.stringify(d)).join(",")+"]";t("{{title}}",e.title??""),t("{{cover_url}}",w(e.coverUrl??"")),t("{{authors_md}}",i),t("{{authors_plain}}",a),t("{{narrators_md}}",u),t("{{narrators_plain}}",n),t("{{length}}",e.length??""),t("{{publisher}}",m),t("{{publisher_plain}}",o),t("{{release_date}}",e.releaseDate??""),t("{{start_date}}",e.startDate??""),t("{{finish_date}}",e.finishDate??""),t("{{series_md}}",h),t("{{series_plain}}",g),t("{{book_md}}",A),t("{{tags}}",f),t("{{tags_yaml}}",b),t("{{status}}",e.status??""),t("{{acquired}}",e.acquired??""),t("{{source}}",e.source??"")}else if("series"in r&&!("title"in r)){let e=r,a=e.tags.map(n=>`#${n}`).join(" "),i="["+e.tags.map(n=>JSON.stringify(n)).join(",")+"]";t("{{series}}",e.series??""),t("{{Series}}",e.series??""),t("{{books}}",e.books??""),t("{{category}}",e.category??""),t("{{tags}}",a),t("{{tags_yaml}}",i)}else{let e=r;t("{{author_plain}}",e.author),t("{{author_md}}",`[[${e.author}]]`),t("{{image_url}}",w(e.imageUrl??""))}return t("{{type}}",r.type??""),t("{{category}}",r.category??""),t("{{url}}",w(r.url??"")),t("{{description}}",(r.description??"").trim()),t("{{rating}}",r.rating??""),s=s.replace(/\n{4,}/g,`


`),s.trim()+`
`}async function he(l,r,s,t,e){let i=(await(0,c.requestUrl)({url:l,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,n=_(i),u=H(n),g=J(u),{title:h,url:A}=ne(n,l,g),o=Y(h),m=ie(n,g),f=W(n,g),b=ae(n,g),d=re(n),k=oe(n,g),x=ge(n),L=le(n,d,g),P=ce(n,d,g),E=ue(n,d,g),S=[],I=JSON.parse(s.tagRulesJson);S.push(...I.baseTags||[]),S.push(...G(n,g));let $=I.categoryTags?.[r.name];return $&&Array.isArray($)&&S.push(...$),S=U(S),{title:o,url:w(A),coverUrl:m,authors:b,narrators:k,series:x,length:L,publisher:P,releaseDate:E,startDate:"",finishDate:"",description:f,category:r.name,status:t??s.defaultStatus,acquired:s.defaultAcquired,source:s.defaultSource,rating:e??String(s.defaultRatingNumber),tags:S,type:"book"}}async function de(l,r,s,t){let a=(await(0,c.requestUrl)({url:l,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,i=_(a),n=H(i),u=J(n),g=i.querySelector("h1")?.textContent?.trim()??"Unknown Author",h=i.querySelector("img.author-profile-picture")?.getAttribute("src")??"";return h||(h=i.querySelector("meta[property='og:image']")?.getAttribute("content")??""),{author:g,url:w(l),imageUrl:w(h),category:"Author",rating:t??"0",description:W(i,u),type:"Author"}}async function pe(l,r,s,t){let a=(await(0,c.requestUrl)({url:l,headers:{"Accept-Language":"en-US,en;q=0.9"}})).text,i=_(a),n=H(i),u=J(n),g=p(i.querySelector("h1")?.textContent??""),h="",A=[i.querySelector(".series-summary-content"),i.querySelector("#series-description .bc-section"),i.querySelector('[data-widget="description"] .bc-text'),i.querySelector('[data-testid="description"]'),i.querySelector(".series-description"),i.querySelector(".bc-expander-content")];for(let d of A)if(d&&(h=p(d.textContent??""),h&&!h.includes("Listen to")&&!h.includes("Audiobooks on Audible")))break;h||(h=W(i,u));let o=G(i,u);if(o.length===0){let d=i.querySelectorAll(".bc-chip");for(let k of Array.from(d)){let x=p(k.textContent??"");x&&o.push(...N(x))}}o=U(o);let m=s,f=i.querySelector(".num-books-in-series"),b="0";if(f){let d=f.textContent?.match(/(\d+)/);d&&(b=d[1])}if(b==="0"){let d=i.querySelector('#series-results, [data-widget="product-list"]'),k=d?T(d,'li.bc-list-item, [data-testid="product-list-item"]'):[];if(k.length>0)b=k.length.toString();else{let x=i.querySelectorAll(".bc-text, .bc-heading");for(let L of Array.from(x)){let E=(L.textContent??"").match(/(\d+)\s+titles/);if(E){b=E[1];break}}}}return{series:g,url:w(l),books:b,description:h,category:m,rating:t??"0",tags:o,type:"Series"}}var F=class extends c.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.status="";this.rating="";this.overwriteOverride=!1;this.createAuthorPage=!1;this.createSeriesPage=!1;this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.status=t.settings.defaultStatus,this.rating=String(t.settings.defaultRatingNumber),this.overwriteOverride=t.settings.overwriteIfExists}async onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Book from Audible"}),new c.Setting(s).setName("Audible URL").setDesc("Paste the Audible book page URL (https://www.audible.com/pd/...)").addText(i=>{i.setPlaceholder("https://www.audible.com/pd/...").onChange(n=>this.url=n.trim()),i.inputEl.style.width="100%"}),new c.Setting(s).setName("Library").setDesc("Select the target library for this book.").addDropdown(i=>{this.plugin.settings.libraries.forEach(n=>{i.addOption(n.id,n.name)}),i.setValue(this.libraryId),i.onChange(n=>this.libraryId=n)}),new c.Setting(s).setName("Status").addText(i=>{i.setValue(this.status).onChange(n=>this.status=n.trim()),i.inputEl.style.width="100%"}),new c.Setting(s).setName("Rating").setDesc("Numeric rating (e.g. 3 or 4.5)").addText(i=>{i.setValue(this.rating).onChange(n=>this.rating=n.trim()),i.inputEl.style.width="100%"}),new c.Setting(s).setName("Overwrite Existing Book").addToggle(i=>{i.setValue(this.overwriteOverride).onChange(n=>this.overwriteOverride=n)});let t=this.plugin.settings.libraries.find(i=>i.id===this.libraryId),e=t&&v(t.authorsFolder);this.plugin.settings.authorTemplatePath&&e&&new c.Setting(s).setName("Create Author's Page").setDesc("Automatically create or update the author's reference page.").addToggle(i=>{i.setValue(this.createAuthorPage).onChange(n=>this.createAuthorPage=n)});let a=t&&v(t.seriesFolder);this.plugin.settings.seriesTemplatePath&&a&&new c.Setting(s).setName("Create Series Page").setDesc("Automatically create or update the series reference page.").addToggle(i=>{i.setValue(this.createSeriesPage).onChange(n=>this.createSeriesPage=n)}),new c.Setting(s).addButton(i=>{i.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new c.Notice("Please enter an Audible URL.");return}let n=this.plugin.settings.libraries.find(u=>u.id===this.libraryId);if(!n){new c.Notice("Selected library not found.");return}this.plugin.settings.activeLibraryId!==this.libraryId&&(this.plugin.settings.activeLibraryId=this.libraryId,await this.plugin.saveSettings()),await this.plugin.createBookFromAudible(this.url,n,this.status,this.rating,this.overwriteOverride,this.createAuthorPage,this.createSeriesPage),this.close()}catch(n){console.error(n),new c.Notice(`Failed: ${n?.message??String(n)}`)}})}),new c.Setting(s).addButton(i=>{i.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},B=class extends c.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.rating="";this.overwriteOverride=!1;this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.rating=String(t.settings.defaultRatingNumber),this.overwriteOverride=t.settings.overwriteIfExists}async onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Author from Audible"}),new c.Setting(s).setName("Audible URL").setDesc("Paste the Audible author page URL").addText(t=>{t.setPlaceholder("https://www.audible.com/author/...").onChange(e=>this.url=e.trim()),t.inputEl.style.width="100%"}),new c.Setting(s).setName("Library").addDropdown(t=>{this.plugin.settings.libraries.forEach(e=>{t.addOption(e.id,e.name)}),t.setValue(this.libraryId),t.onChange(e=>this.libraryId=e)}),new c.Setting(s).setName("Rating").addText(t=>{t.setValue(this.rating).onChange(e=>this.rating=e.trim()),t.inputEl.style.width="100%"}),new c.Setting(s).setName("Overwrite Existing Author").addToggle(t=>{t.setValue(this.overwriteOverride).onChange(e=>this.overwriteOverride=e)}),new c.Setting(s).addButton(t=>{t.setButtonText("Create").setCta().onClick(async()=>{try{if(!this.url){new c.Notice("Please enter an Audible URL.");return}let e=this.plugin.settings.libraries.find(a=>a.id===this.libraryId);if(!e){new c.Notice("Selected library not found.");return}await this.plugin.createAuthorFromAudible(this.url,e,this.rating,this.overwriteOverride),this.close()}catch(e){console.error(e),new c.Notice(`Failed: ${e?.message??String(e)}`)}})}),new c.Setting(s).addButton(t=>{t.setButtonText("Cancel").onClick(()=>this.close())})}onClose(){this.contentEl.empty()}},q=class extends c.Modal{constructor(s,t){super(s);this.url="";this.libraryId="";this.rating="";this.overwriteOverride=!1;this.plugin=t,this.libraryId=t.settings.activeLibraryId,this.rating=String(t.settings.defaultRatingNumber),this.overwriteOverride=t.settings.overwriteIfExists}onOpen(){let{contentEl:s}=this;s.empty(),s.createEl("h2",{text:"Create Series Page from Audible"}),new c.Setting(s).setName("Audible Series URL").setDesc("Paste the Audible series page URL").addText(t=>{t.setPlaceholder("https://www.audible.com/series/...").onChange(e=>this.url=e.trim()),t.inputEl.style.width="100%"}),new c.Setting(s).setName("Library").setDesc("Select the target library for this series.").addDropdown(t=>{this.plugin.settings.libraries.forEach(e=>{t.addOption(e.id,e.name)}),t.setValue(this.libraryId),t.onChange(e=>this.libraryId=e)}),new c.Setting(s).setName("Rating").setDesc("Numeric rating (e.g. 3 or 4.5)").addText(t=>{t.setValue(this.rating).onChange(e=>this.rating=e.trim()),t.inputEl.style.width="100%"}),new c.Setting(s).setName("Overwrite Existing Series").addToggle(t=>{t.setValue(this.overwriteOverride).onChange(e=>this.overwriteOverride=e)}),new c.Setting(s).addButton(t=>t.setButtonText("Create Series Page").setCta().onClick(async()=>{if(!this.url){new c.Notice("Please enter a URL.");return}let e=this.plugin.settings.libraries.find(a=>a.id===this.libraryId);e&&(this.close(),await this.plugin.createSeriesFromAudible(this.url,e,this.rating,this.overwriteOverride))}))}onClose(){this.contentEl.empty()}},O=class extends c.Plugin{constructor(){super(...arguments);this.ribbonIcons=[]}async onload(){console.log(`Audible Library Creator v${this.manifest.version} loading...`),await this.loadSettings(),this.refreshRibbonIcons(),this.addCommand({id:"add-audible-book",name:"Add Audible Book",callback:()=>new F(this.app,this).open()}),this.addCommand({id:"add-audible-author",name:"Add Audible Author",callback:()=>new B(this.app,this).open()}),this.addCommand({id:"add-audible-series",name:"Add Audible Series",callback:()=>new q(this.app,this).open()}),this.addSettingTab(new R(this.app,this))}refreshRibbonIcons(){if(this.ribbonIcons.forEach(s=>s.remove()),this.ribbonIcons=[],this.settings.showBookRibbonIcon){let s=this.addRibbonIcon("book-open","Add Audible Book",()=>{new F(this.app,this).open()});this.ribbonIcons.push(s)}if(this.settings.showSeriesRibbonIcon){let s=this.addRibbonIcon("library","Add Audible Series",()=>{new q(this.app,this).open()});this.ribbonIcons.push(s)}if(this.settings.showAuthorRibbonIcon){let s=this.addRibbonIcon("user","Add Audible Author",()=>{new B(this.app,this).open()});this.ribbonIcons.push(s)}}async loadSettings(){this.settings=Object.assign({},z,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createBookFromAudible(s,t,e,a,i,n,u){let g=this.settings,h=v(t.booksRoot);this.app.vault.getAbstractFileByPath(h)||await this.app.vault.createFolder(h),new c.Notice("Fetching Audible page\u2026");let o=await he(s,t,g,e,a),m=g.authorTemplatePath,f=v(t.authorsFolder);if(n&&m&&f&&o.authors?.length){for(let S of o.authors)if(S.url){let I=S.url.startsWith("http")?S.url:`https://www.audible.com${S.url}`;await this.createAuthorFromAudible(I,t)}o.authors_md_override=o.authors.map(S=>`[[${S.name}]]`).join(`,  
`)}let b=g.seriesTemplatePath,d=v(t.seriesFolder);if(u&&b&&d&&o.series?.url){let S=o.series.url.startsWith("http")?o.series.url:`https://www.audible.com${o.series.url}`;await this.createSeriesFromAudible(S,t),o.series.name=`[[${o.series.name}]]`}let k=await V(this.app,g.bookTemplatePath),x=j(k,o),L=v(`${h}/${o.title}.md`),P=this.app.vault.getAbstractFileByPath(L),E=i??g.overwriteIfExists;if(P&&P instanceof c.TFile){if(!E){new c.Notice(`File exists: ${L}`),g.openCreatedFile&&await this.app.workspace.getLeaf(!1).openFile(P);return}await this.app.vault.modify(P,x),new c.Notice(`Updated: ${o.title}`)}else await this.app.vault.create(L,x),new c.Notice(`Created: ${o.title}`);if(g.openCreatedFile){let S=this.app.vault.getAbstractFileByPath(L);S&&S instanceof c.TFile&&await this.app.workspace.getLeaf(!1).openFile(S)}}async createAuthorFromAudible(s,t,e,a){try{let i=v(t.authorsFolder);if(!i){new c.Notice("Author folder not defined for this library. Author page creation skipped.");return}new c.Notice("Scraping author...");let n=await de(s,t,this.settings,e),u=this.settings.authorTemplatePath;if(!u){new c.Notice("Author template path not defined. Author page creation skipped.");return}let g=await V(this.app,u),h=j(g,n),A=`${n.author}.md`,o=`${i}/${A}`;this.app.vault.getAbstractFileByPath(i)||await this.app.vault.createFolder(i);let f=this.app.vault.getAbstractFileByPath(o),b=a??this.settings.overwriteIfExists;if(f&&f instanceof c.TFile){if(!b){new c.Notice("Author page already exists.");return}await this.app.vault.modify(f,h),new c.Notice(`Updated author page: ${n.author}`)}else await this.app.vault.create(o,h),new c.Notice(`Author page created: ${n.author}`);if(this.settings.openCreatedFile){let d=this.app.vault.getAbstractFileByPath(o);d instanceof c.TFile&&await this.app.workspace.getLeaf(!1).openFile(d)}}catch(i){console.error(i),new c.Notice(`Error: ${i.message}`)}}async createSeriesFromAudible(s,t,e,a){try{let i=v(t.seriesFolder);if(!i){new c.Notice("Series folder not defined for this library. Series page creation skipped.");return}new c.Notice("Scraping series...");let n=await pe(s,this.settings,t.name,e),u=this.settings.seriesTemplatePath;if(!u){new c.Notice("Series template path not defined. Series page creation skipped.");return}let g=await V(this.app,u),h=j(g,n),A=`${Y(n.series)}.md`,o=`${i}/${A}`;this.app.vault.getAbstractFileByPath(i)||await this.app.vault.createFolder(i);let f=this.app.vault.getAbstractFileByPath(o),b=a??this.settings.overwriteIfExists;if(f&&f instanceof c.TFile){if(!b){new c.Notice("Series page already exists.");return}await this.app.vault.modify(f,h),new c.Notice(`Updated series page: ${n.series}`)}else await this.app.vault.create(o,h),new c.Notice(`Series page created: ${n.series}`);if(this.settings.openCreatedFile){let d=this.app.vault.getAbstractFileByPath(o);d instanceof c.TFile&&await this.app.workspace.getLeaf(!1).openFile(d)}}catch(i){console.error(i),new c.Notice(`Error: ${i.message}`)}}};
